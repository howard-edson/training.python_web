<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Internet Programming with Python</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Internet Programming with Python</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Internet Programming with Python</h1>

<img alt="img/pyramid-medium.png" class="align-left" src="img/pyramid-medium.png" style="width: 50%;" />
<p>Session 10: A Pyramid Application</p>
<div class="intro-blurb right line-block">
<div class="line">The flexible framework.</div>
<div class="line">Totally not built by aliens.</div>
</div>

</div>
<div class="slide" id="adding-templates">
<h1>Adding Templates</h1>
<p>What is the page template name for <tt class="docutils literal">view_page</tt>?</p>
<p class="incremental">Create <tt class="docutils literal">view.pt</tt> in your <tt class="docutils literal">templates</tt> directory.</p>
<p class="incremental">Also copy the file <tt class="docutils literal">base.pt</tt> from the class resources.</p>
<p class="incremental">Pyramid can use a number of different templating engines.</p>
<p class="incremental">We'll be using Chameleon, which also supports extending other templates.</p>
</div>
<div class="slide" id="chameleon-templates">
<h1>Chameleon Templates</h1>
<p>Chameleon page templates are valid XML/HTML.</p>
<p class="incremental">You can validate and view templates in browsers without the templating engine.</p>
<p class="incremental">This can be helpful in working with designers or front-end folks</p>
<p class="incremental">Instead of using special tags for processing directives, Chameleon uses XML
tag attributes.</p>
</div>
<div class="slide" id="tal-metal">
<h1>TAL/METAL</h1>
<p>Chameleon is descended from Zope Page Templates (ZPT)</p>
<p class="incremental">It uses two XML namespaces for directives:</p>
<ul class="incremental simple">
<li>TAL (Template Attribute Language)</li>
<li>METAL (Macro Extension to the Template Attribute Language)</li>
</ul>
<p class="incremental">TAL provides basic directives for logical structures</p>
<p class="incremental">METAL provides directives for creating and using template Macros</p>
</div>
<div class="slide" id="tal-statements">
<h1>TAL Statements</h1>
<p>TAL and METAL statements are XML tag attributes.</p>
<p class="incremental">This means they look just like <tt class="docutils literal"><span class="pre">id=&quot;foo&quot;</span></tt> or <tt class="docutils literal"><span class="pre">class=&quot;bar&quot;</span></tt></p>
<ul class="incremental simple">
<li><tt class="docutils literal"><span class="pre">tal:&lt;operator&gt;=”&lt;expression&gt;”</span></tt></li>
<li>The <tt class="docutils literal">tal:</tt> is a ‘namespace identifier’ (xml)<ul>
<li>Not strictly required, but helpful</li>
<li>Strongly encouraged :)</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="tal-operators">
<h1>TAL Operators</h1>
<p>There are seven basic TAL operators, which are processed in this order</p>
<ul class="incremental simple">
<li><tt class="docutils literal">tal:define</tt> - set a value or values</li>
<li><tt class="docutils literal">tal:condition</tt> - test truth value to execute</li>
<li><tt class="docutils literal">tal:repeat</tt> - loop over sets of values</li>
<li><tt class="docutils literal">tal:content</tt> - set the content of a tag</li>
<li><tt class="docutils literal">tal:replace</tt> - replace an entire tag</li>
<li><tt class="docutils literal">tal:attributes</tt> - set html/xml attributes of a tag</li>
<li><tt class="docutils literal"><span class="pre">tal:omit-tag</span></tt> - if expression is false, omit the tag</li>
</ul>
<p class="incremental"><tt class="docutils literal">content</tt> and <tt class="docutils literal">replace</tt> are mutually exclusive.</p>
</div>
<div class="slide" id="tal-expressions">
<h1>TAL Expressions</h1>
<p>The right half of a TAL statement is an <em>expression</em> using the TAL expression
syntax (TALES):</p>
<ul class="incremental simple">
<li>Exists - <tt class="docutils literal">exists:foo</tt></li>
<li>Import - <tt class="docutils literal">import:foo.bar.baz</tt></li>
<li>Load = <tt class="docutils literal"><span class="pre">load:../other_template.pt</span></tt></li>
<li>Not - <tt class="docutils literal">not: is_anon</tt></li>
<li>Python - <tt class="docutils literal">python: here.Title()</tt></li>
<li>String - <tt class="docutils literal">string:my ${value}</tt></li>
<li>Structure - <tt class="docutils literal">structure:some_html</tt></li>
</ul>
</div>
<div class="slide" id="metal-operators">
<h1>METAL Operators</h1>
<p>METAL provides operators related to creating and using template macros:</p>
<ul class="incremental simple">
<li><tt class="docutils literal"><span class="pre">metal:define-macro</span></tt> - designates a DOM scope as a macro</li>
<li><tt class="docutils literal"><span class="pre">metal:use-macro</span></tt> - indicates that a macro should be used</li>
<li><tt class="docutils literal"><span class="pre">metal:extend-macro</span></tt> - extend an existing macro</li>
<li><tt class="docutils literal"><span class="pre">metal:define-slot</span></tt> - designate a customization point for a macro</li>
<li><tt class="docutils literal"><span class="pre">metal:fill-slot</span></tt> - provide custom content for a macro slot</li>
</ul>
<p class="incremental">Much of this will become clearer as we actually create our templates.</p>
</div>
<div class="slide" id="the-view-pt-template">
<h1>The view.pt Template</h1>
<p>Type this code into your <tt class="docutils literal">view.pt</tt> file:</p>
<pre class="code xml literal-block">
<span class="nt">&lt;metal:main</span> <span class="na">use-macro=</span><span class="s">&quot;load: base.pt&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;metal:content</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;main-content&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">tal:replace=</span><span class="s">&quot;structure:content&quot;</span><span class="nt">&gt;</span>
    Page text goes here.
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">tal:attributes=</span><span class="s">&quot;href edit_url&quot;</span> <span class="na">href=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
      Edit this page
    <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
 <span class="nt">&lt;/metal:content&gt;</span>
<span class="nt">&lt;/metal:main&gt;</span>
</pre>
</div>
<div class="slide" id="a-few-notes">
<h1>A Few Notes</h1>
<p><tt class="docutils literal">&lt;metal&gt;</tt> and <tt class="docutils literal">&lt;tal&gt;</tt> tags are processed and removed by the engine.</p>
<ul class="incremental simple">
<li><tt class="docutils literal"><span class="pre">use-macro=&quot;load:</span> base.pt&quot;</tt>: we will be using <tt class="docutils literal">base.pt</tt> as our main
template <em>macro</em>.</li>
<li>Template <em>macros</em> define one or more <em>slots</em>.</li>
<li><tt class="docutils literal"><span class="pre">metal:fill-slot=&quot;main-content&quot;</span></tt>: everything goes in the <tt class="docutils literal"><span class="pre">main-content</span></tt>
slot.</li>
</ul>
</div>
<div class="slide" id="more-notes">
<h1>More Notes</h1>
<pre class="code xml literal-block">
<span class="nt">&lt;div</span> <span class="na">tal:replace=</span><span class="s">&quot;structure:content&quot;</span><span class="nt">&gt;</span>
  Page text goes here.
<span class="nt">&lt;/div&gt;</span>
</pre>
<p>The <tt class="docutils literal">tal</tt> directive <tt class="docutils literal">replace</tt> replaces the <tt class="docutils literal">&lt;div&gt;</tt> tag with <tt class="docutils literal">content</tt>.</p>
<p>The <tt class="docutils literal">structure</tt> expression ensures that the HTML is not escaped.</p>
<div class="incremental container">
<pre class="code xml literal-block">
<span class="nt">&lt;a</span> <span class="na">tal:attributes=</span><span class="s">&quot;href edit_url&quot;</span> <span class="na">href=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  Edit this page
<span class="nt">&lt;/a&gt;</span>
</pre>
<p>Here, we use the <tt class="docutils literal">tal</tt> directive <tt class="docutils literal">attributes</tt> to set the <tt class="docutils literal">href</tt> for
our anchor to the value passed into our template as <tt class="docutils literal">edit_url</tt>.</p>
</div>
</div>
<div class="slide" id="view-your-work">
<h1>View Your Work</h1>
<p>We've created the following:</p>
<ul class="incremental small simple">
<li>A wiki view that redirects to the automatically-created FrontPage page</li>
<li>A page view that will render the <tt class="docutils literal">data</tt> from a page, along with a url for
editing that page</li>
<li>A page template to show a wiki page.</li>
</ul>
<p class="incremental">That's all we need to be able to see our work.  Start Pyramid:</p>
<pre class="incremental small literal-block">
(pyramidenv)$ pserve development.ini
Starting server in PID 43925.
serving on http://0.0.0.0:6543
</pre>
<p class="incremental">Load <a class="reference external" href="http://localhost:6543/">http://localhost:6543/</a></p>
</div>
<div class="slide" id="what-you-should-see">
<h1>What You Should See</h1>
<img alt="img/wiki_frontpage.png" class="align-center" src="img/wiki_frontpage.png" style="width: 95%;" />
</div>
<div class="slide" id="page-editing">
<h1>Page Editing</h1>
<p>You'll notice that the page has a link to <tt class="docutils literal">Edit This Page</tt></p>
<p class="incremental">If you click it, you get a 404.  We haven't created that view yet.</p>
<p class="incremental">Let's start by adding tests to ensure:</p>
<ul class="incremental simple">
<li>the edit view will submit to itself</li>
<li>will save page data updates</li>
<li>will redirect back to the page view after saving</li>
</ul>
</div>
<div class="slide" id="test-page-editing">
<h1>Test Page Editing</h1>
<p>In <tt class="docutils literal">tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">EditPageTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_callFUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">edit_page</span>
        <span class="k">return</span> <span class="n">edit_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_it_notsubmitted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyResource</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyRequest</span><span class="p">()</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s">'page'</span><span class="p">],</span> <span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s">'save_url'</span><span class="p">],</span>
                         <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">'edit_page'</span><span class="p">))</span>
</pre>
</div>
<div class="slide" id="one-more-method">
<h1>One More Method</h1>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">EditPageTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">test_it_submitted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyResource</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyRequest</span><span class="p">({</span><span class="s">'form.submitted'</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="s">'body'</span><span class="p">:</span><span class="s">'Chapel Hill Rocks'</span><span class="p">})</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s">'http://example.com/'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">'Chapel Hill Rocks'</span><span class="p">)</span>
</pre>
<pre class="small incremental literal-block">
(pyramidenv)$ python setup.py test
Ran 7 tests in 0.110s
FAILED (errors=2)
</pre>
</div>
<div class="slide" id="editing-a-page">
<h1>Editing a Page</h1>
<p>Back in <tt class="docutils literal">views.py</tt> add the following:</p>
<pre class="code python small literal-block">
<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'edit_page'</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s">'.models.Page'</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s">'templates/edit.pt'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">'form.submitted'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'body'</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                <span class="n">save_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">'edit_page'</span><span class="p">))</span>
</pre>
<p class="incremental">Note the <tt class="docutils literal">name</tt> in <tt class="docutils literal">view_config</tt>.</p>
<p class="incremental">When traversal runs out of objects, it tries to find views by name</p>
</div>
<div class="slide" id="check-your-tests">
<h1>Check Your Tests</h1>
<p>Even without a template we can run our tests:</p>
<pre class="small incremental literal-block">
(pyramidenv)$ python setup.py test
...
----------------------------------------------------------------------
Ran 7 tests in 0.112s

OK
</pre>
</div>
<div class="slide" id="the-edit-template">
<h1>The Edit Template</h1>
<p>Create and fill <tt class="docutils literal">edit.pt</tt> in <tt class="docutils literal">templates</tt>:</p>
<pre class="code xml small literal-block">
<span class="nt">&lt;metal:main</span> <span class="na">use-macro=</span><span class="s">&quot;load: base.pt&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;metal:pagename</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;page-name&quot;</span><span class="nt">&gt;</span>
  Editing
  <span class="nt">&lt;b&gt;&lt;span</span> <span class="na">tal:replace=</span><span class="s">&quot;page.__name__&quot;</span><span class="nt">&gt;</span>Page Name Goes Here
     <span class="nt">&lt;/span&gt;&lt;/b&gt;</span>
  <span class="nt">&lt;/metal:pagename&gt;</span>
  <span class="nt">&lt;metal:content</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;main-content&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;${save_url}&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;body&quot;</span> <span class="na">tal:content=</span><span class="s">&quot;page.data&quot;</span> <span class="na">rows=</span><span class="s">&quot;10&quot;</span>
                <span class="na">cols=</span><span class="s">&quot;60&quot;</span><span class="nt">/&gt;&lt;br/&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form.submitted&quot;</span> <span class="na">value=</span><span class="s">&quot;Save&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
  <span class="nt">&lt;/metal:content&gt;</span>
<span class="nt">&lt;/metal:main&gt;</span>
</pre>
</div>
<div class="slide" id="frontpage-content">
<h1>FrontPage Content</h1>
<p>Restart Pyramid, then back in your browser, click the <tt class="docutils literal">Edit this page</tt> link.</p>
<p class="incremental">Erase the existing text and add this instead:</p>
<pre class="incremental small literal-block">
==========
Front Page
==========

This is the front page.  It features

* a heading
* a list
* a wikiword link to AnotherPage
</pre>
</div>
<div class="slide" id="id1">
<h1>View Your Work</h1>
<p>Click the <em>Save</em> button and see what you've gotten.</p>
<p class="incremental">If you get strangely formatted text that warns you about <em>Title overline too
short</em>, you didn't add enough equals signs above or below the page title. Go
back and ensure that there are the same number of equal signs as the total
number of characters in the title.</p>
<p class="incremental">Note that <tt class="docutils literal">AnotherPage</tt> is a link, click it.</p>
</div>
<div class="slide" id="page-creation">
<h1>Page Creation</h1>
<p>Again, we need a new view.  This one will</p>
<ul class="incremental simple">
<li>have the wiki itself as <tt class="docutils literal">context</tt></li>
<li>allow us to fill out the new page content</li>
<li>save the new page when submitted</li>
<li>return us to a view of the new page</li>
</ul>
<p class="incremental">Again, we start by testing for this</p>
</div>
<div class="slide" id="test-adding-a-page">
<h1>Test Adding a Page</h1>
<p>In <tt class="docutils literal">tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">AddPageTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_callFUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">add_page</span>
        <span class="k">return</span> <span class="n">add_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_it_notsubmitted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyResource</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyRequest</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">subpath</span> <span class="o">=</span> <span class="p">[</span><span class="s">'AnotherPage'</span><span class="p">]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s">'page'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">info</span><span class="p">[</span><span class="s">'save_url'</span><span class="p">],</span>
            <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">'add_page'</span><span class="p">,</span> <span class="s">'AnotherPage'</span><span class="p">))</span>
</pre>
</div>
<div class="slide" id="id2">
<h1>One More Method</h1>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">AddPageTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c">#...</span>

    <span class="k">def</span> <span class="nf">test_it_submitted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyResource</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyRequest</span><span class="p">({</span><span class="s">'form.submitted'</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="s">'body'</span><span class="p">:</span><span class="s">'Go UNC!'</span><span class="p">})</span>
        <span class="n">request</span><span class="o">.</span><span class="n">subpath</span> <span class="o">=</span> <span class="p">[</span><span class="s">'AnotherPage'</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">'AnotherPage'</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">'Go UNC!'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">'AnotherPage'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">__parent__</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre>
<pre class="small incremental literal-block">
(pyramidenv)$ python setup.py test
Ran 9 tests in 0.117s
FAILED (errors=2)
</pre>
</div>
<div class="slide" id="adding-a-page">
<h1>Adding a Page</h1>
<p>Back in <tt class="docutils literal">views.py</tt> add the code for creating a new page</p>
<div class="incremental container">
<p>Start with imports and the view_config:</p>
<pre class="code python small literal-block">
<span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">wikitutorial.models</span> <span class="kn">import</span> <span class="n">Page</span>

<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'add_page'</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s">'.models.Wiki'</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s">'templates/edit.pt'</span><span class="p">)</span>
</pre>
</div>
</div>
<div class="slide" id="the-view-function">
<h1>The View Function</h1>
<pre class="code python small literal-block">
<span class="nd">&#64;view_config</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c">#&lt;- already there.</span>
<span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">subpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">'form.submitted'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'body'</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">pagename</span>
        <span class="n">page</span><span class="o">.</span><span class="n">__parent__</span> <span class="o">=</span> <span class="n">context</span>
        <span class="n">context</span><span class="p">[</span><span class="n">pagename</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
    <span class="n">save_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">'add_page'</span><span class="p">,</span> <span class="n">pagename</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">pagename</span>
    <span class="n">page</span><span class="o">.</span><span class="n">__parent__</span> <span class="o">=</span> <span class="n">context</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">save_url</span><span class="o">=</span><span class="n">save_url</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id3">
<h1>A Few Notes</h1>
<p>Note that this view also has a <tt class="docutils literal">name</tt>.</p>
<p class="incremental"><tt class="docutils literal">pagename = request.subpath[0]</tt> gives us the first element of the path
<em>after</em> the current context and view name. What is that?</p>
<p class="incremental">Notice that <em>here</em> is where we set the <tt class="docutils literal">__name__</tt> and <tt class="docutils literal">__parent__</tt>
attributes of our new Page.</p>
<p class="incremental">We add a new Page to the wiki as if the wiki were a Python <tt class="docutils literal">dict</tt>:
<tt class="docutils literal">context[pagename] = page</tt></p>
</div>
<div class="slide" id="one-more-note">
<h1>One More Note</h1>
<p>Look at the similarity in how a form is handled here to the way it is handled
in Django and Flask (in pseudocode):</p>
<pre class="incremental literal-block">
if the_form_is_submitted:
    handle_the_form()
    return go_to_the_success_url()
return an_empty_form()
</pre>
<p class="incremental">Forms that modify data should only be handled on POST.</p>
<p class="incremental">Could you improve this code to ensure that?</p>
</div>
<div class="slide" id="and-a-question">
<h1>And a Question</h1>
<p class="big-centered">Why do we create a new, empty <tt class="docutils literal">Page</tt> object at the end of the add_page view?</p>
</div>
<div class="slide" id="id4">
<h1>Check Your Tests</h1>
<pre class="small literal-block">
(pyramidenv)$ python setup.py test
...
test_it_notsubmitted (wikitutorial.tests.AddPageTests) ... ok
test_it_submitted (wikitutorial.tests.AddPageTests) ... ok
test_initialization (wikitutorial.tests.AppmakerTests) ... ok
test_it_notsubmitted (wikitutorial.tests.EditPageTests) ... ok
test_it_submitted (wikitutorial.tests.EditPageTests) ... ok
test_constructor (wikitutorial.tests.PageModelTests) ... ok
test_it (wikitutorial.tests.PageViewTests) ... ok
test_constructor (wikitutorial.tests.WikiModelTests) ... ok
test_redirect (wikitutorial.tests.WikiViewTests) ... ok

----------------------------------------------------------------------
Ran 9 tests in 0.111s

OK
</pre>
<p class="incremental center"><strong>WAHOOOOOOO!!!</strong></p>
</div>
<div class="slide" id="security">
<h1>Security</h1>
<p>We've got a solid start on a wiki that works.</p>
<p class="incremental">But everyone who visits the wiki can author and edit pages.</p>
<p class="incremental">It's a recipe for <strong>TOTAL CHAOS</strong></p>
<p class="incremental">Let's lock it down a bit.</p>
</div>
<div class="slide" id="authn-and-authz">
<h1>AuthN and AuthZ</h1>
<p>There are two aspects to the process of access control online.</p>
<ul class="incremental simple">
<li><strong>Authentication</strong>: Verification of the identity of a <em>principal</em></li>
<li><strong>Authorization</strong>: Enumeration of the rights of that <em>principal</em> in a
context.</li>
</ul>
<p class="incremental">All systems with access control involve both of these aspects.</p>
<p class="incremental">AuthZ in our Flask and Django apps was minimal</p>
</div>
<div class="slide" id="pyramid-security">
<h1>Pyramid Security</h1>
<p>In Pyramid these two aspects are handled by separate configuration settings:</p>
<ul class="incremental simple">
<li><tt class="docutils literal"><span class="pre">config.set_authentication_policy(AuthnPolicy())</span></tt></li>
<li><tt class="docutils literal"><span class="pre">config.set_authorization_policy(AuthzPolicy())</span></tt></li>
</ul>
<p class="incremental">If you set one, you must set the other.</p>
<p class="incremental">Pyramid comes with a few policy classes included.</p>
<p class="incremental">You can also roll your own, so long as they fulfill the contract.</p>
</div>
<div class="slide" id="our-wiki-security">
<h1>Our Wiki Security</h1>
<p>We'll be using two built-in policies today:</p>
<ul class="incremental simple">
<li><tt class="docutils literal">AuthTktAuthenticationPolicy</tt>: sets an expirable authentication ticket
cookie.</li>
<li><tt class="docutils literal">ACLAuthorizationPolicy</tt>: uses an <em>Access Control List</em> to grant
permissions to <em>principals</em></li>
</ul>
<p class="incremental">Our access control system will have the following properties:</p>
<ul class="incremental simple">
<li>Everyone can view pages</li>
<li>Users who log in may be added to an 'editors' group</li>
<li>Editors can add and edit pages.</li>
</ul>
</div>
<div class="slide" id="testing-first">
<h1>Testing First</h1>
<p>Let's begin by testing for our desired properties.</p>
<p class="incremental">We'll need to create a new TestCase for this.</p>
<p class="incremental">This TestCase will be a bit different.  We need a request to engage security</p>
<p class="incremental">These tests will be <em>functional tests</em> where our earlier tests were <em>unit
tests</em></p>
<p class="incremental">We'll set up a zodb and a full-fledged app.</p>
</div>
<div class="slide" id="in-tests-py">
<h1>In tests.py</h1>
<p>We'll need some information for testing logging in:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">FunctionalTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="n">viewer_login</span> <span class="o">=</span> <span class="s">'/login?login=viewer&amp;password=viewer'</span> \
                   <span class="s">'&amp;came_from=FrontPage&amp;form.submitted=Login'</span>
    <span class="n">viewer_wrong_login</span> <span class="o">=</span> <span class="s">'/login?login=viewer&amp;password=incorrect'</span> \
                   <span class="s">'&amp;came_from=FrontPage&amp;form.submitted=Login'</span>
    <span class="n">editor_login</span> <span class="o">=</span> <span class="s">'/login?login=editor&amp;password=editor'</span> \
                   <span class="s">'&amp;came_from=FrontPage&amp;form.submitted=Login'</span>
</pre>
</div>
<div class="slide" id="test-setup">
<h1>Test Setup</h1>
<p>We'll also need to create an app and provide a zodb to hold it:</p>
<pre class="code python tiny literal-block">
<span class="k">class</span> <span class="nc">FunctionalTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c">#...</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="kn">import</span> <span class="nn">os.path</span>
        <span class="kn">from</span> <span class="nn">wikitutorial</span> <span class="kn">import</span> <span class="n">main</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="n">dbpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s">'test.db'</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="s">'file://'</span> <span class="o">+</span> <span class="n">dbpath</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span> <span class="s">'zodbconn.uri'</span> <span class="p">:</span> <span class="n">uri</span> <span class="p">,</span>
                     <span class="s">'pyramid.includes'</span><span class="p">:</span> <span class="p">[</span><span class="s">'pyramid_zodbconn'</span><span class="p">,</span>
                                          <span class="s">'pyramid_tm'</span><span class="p">]</span> <span class="p">}</span>

        <span class="n">app</span> <span class="o">=</span> <span class="n">main</span><span class="p">({},</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">_zodb_databases</span><span class="p">[</span><span class="s">''</span><span class="p">]</span>
        <span class="kn">from</span> <span class="nn">webtest</span> <span class="kn">import</span> <span class="n">TestApp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span> <span class="o">=</span> <span class="n">TestApp</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="test-teardown">
<h1>Test Teardown</h1>
<p>And since we set all that up, we need to destroy it after each test, too:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">shutil</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="p">)</span>
</pre>
</div>
<div class="slide" id="testing-login">
<h1>Testing Login</h1>
<p>Let's add a few tests to demonstrate that <tt class="docutils literal">AuthN</tt> works:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_successful_log_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer_login</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s">'http://localhost/FrontPage'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_failed_log_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer_wrong_login</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'login'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="testing-anonymous-users">
<h1>Testing Anonymous Users</h1>
<p>We should verify that anonymous users can see pages, but cannot edit or add:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_anonymous_user_cannot_edit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/FrontPage/edit_page'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'Login'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_anonymous_user_cannot_add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/add_page/NewPage'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'Login'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="testing-viewers">
<h1>Testing Viewers</h1>
<p>Authenticated users who are not editors should be the same:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_viewer_user_cannot_edit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer_login</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/FrontPage/edit_page'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'Login'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_viewer_user_cannot_add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer_login</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/add_page/NewPage'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'Login'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="testing-editors">
<h1>Testing Editors</h1>
<p>Finally, editors should be able to do it all:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_editors_member_user_can_edit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor_login</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/FrontPage/edit_page'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'Editing'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_editors_member_user_can_add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor_login</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/add_page/NewPage'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'Editing'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_editors_member_user_can_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">editor_login</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/FrontPage'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'FrontPage'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="one-bit-of-cleanup">
<h1>One Bit of Cleanup</h1>
<p>These lines in our test setup will cause us problems:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">webtest</span> <span class="kn">import</span> <span class="n">TestApp</span>
<span class="bp">self</span><span class="o">.</span><span class="n">testapp</span> <span class="o">=</span> <span class="n">TestApp</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre>
<p class="incremental">We have introduced a dependency on the package <tt class="docutils literal">webtest</tt></p>
<p class="incremental">Our package should be explicit about its dependencies.</p>
<p class="incremental">Do you remember how to declare a dependency?</p>
</div>
<div class="slide" id="fix-setup-py-re-install">
<h1>Fix setup.py / re-install</h1>
<p>In <tt class="docutils literal">setup.py</tt> find <tt class="docutils literal">requires</tt> and add the following:</p>
<pre class="code python small literal-block">
<span class="n">requires</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c">#...</span>
    <span class="s">'docutils'</span><span class="p">,</span>
    <span class="s">'webtest'</span><span class="p">,</span> <span class="c">#&lt;- we are adding this line</span>
    <span class="p">]</span>
</pre>
<p class="incremental">Then, re-install our package using <tt class="docutils literal">develop</tt>:</p>
<pre class="incremental small literal-block">
(pyramidenv)$ python setup.py develop
</pre>
</div>
<div class="slide" id="run-our-tests">
<h1>Run Our Tests</h1>
<p>We can run these tests, to verify that they don't just work:</p>
<pre class="small incremental literal-block">
(pyramidenv)$ python setup.py test

----------------------------------------------------------------------
Ran 18 tests in 1.032s

FAILED (failures=2, errors=7)
</pre>
<p class="incremental">Great!  Lot's of problems to fix!</p>
</div>
<div class="slide" id="contextual-acls">
<h1>Contextual ACLs</h1>
<p>In Pyramid, ACL security is <em>contextual</em>.</p>
<p class="incremental">What a user is allowed to do is dependent on <em>context</em>.</p>
<p class="incremental">In a <em>traversal</em> app, context is defined as the object you are viewing.</p>
<p class="incremental">A <em>view</em> can require a given permission.</p>
<p class="incremental">The object viewed is responsible for determining <em>who</em> has <em>what rights</em>.</p>
</div>
<div class="slide" id="acl-inheritance">
<h1>ACL Inheritance</h1>
<p>Under the default ACL policy, permissions are inherited.</p>
<p class="incremental">If <em>this</em> object does not declare an ACL, then its <tt class="docutils literal">__parent__</tt> is checked</p>
<p class="incremental">If you get all the way back to the root without hitting an ACL, then access is
denied.</p>
<p class="incremental">Thus, the default ACL policy is secure by default.</p>
<p class="incremental">Let's set up our policy.</p>
</div>
<div class="slide" id="our-users-and-groups">
<h1>Our Users and Groups</h1>
<p>Create a new file <tt class="docutils literal">security.py</tt> in your wikitutorial package and add the
following:</p>
<pre class="code python small incremental literal-block">
<span class="n">USERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'editor'</span><span class="p">:</span> <span class="s">'editor'</span><span class="p">,</span>
    <span class="s">'viewer'</span><span class="p">:</span> <span class="s">'viewer'</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">GROUPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'editor'</span><span class="p">:</span> <span class="p">[</span><span class="s">'group:editors'</span><span class="p">],</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">groupfinder</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">userid</span> <span class="ow">in</span> <span class="n">USERS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GROUPS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="p">[])</span>
</pre>
</div>
<div class="slide" id="security-configuration">
<h1>Security Configuration</h1>
<p>In our <tt class="docutils literal">__init__.py</tt> file, add the following:</p>
<pre class="code python small literal-block">
<span class="c"># a few imports</span>
<span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="kn">import</span> <span class="n">AuthTktAuthenticationPolicy</span>
<span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="kn">import</span> <span class="n">ACLAuthorizationPolicy</span>
<span class="kn">from</span> <span class="nn">.security</span> <span class="kn">import</span> <span class="n">groupfinder</span>

<span class="c"># and some configuration</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function returns a Pyramid WSGI application.
    &quot;&quot;&quot;</span>
    <span class="n">authn_policy</span> <span class="o">=</span> <span class="n">AuthTktAuthenticationPolicy</span><span class="p">(</span>
        <span class="s">'youdontknowit'</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">groupfinder</span><span class="p">,</span> <span class="n">hashalg</span><span class="o">=</span><span class="s">'sha512'</span><span class="p">)</span>
    <span class="n">authz_policy</span> <span class="o">=</span> <span class="n">ACLAuthorizationPolicy</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c">#&lt;- already there</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">authz_policy</span><span class="p">)</span>
    <span class="c">#...</span>
</pre>
</div>
<div class="slide" id="add-an-acl">
<h1>Add an ACL</h1>
<p>We can set a global ACL on our wiki root class:</p>
<pre class="code python small literal-block">
<span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span>

<span class="c"># and alter our wiki class:</span>
<span class="k">class</span> <span class="nc">Wiki</span><span class="p">(</span><span class="n">PersistentMapping</span><span class="p">):</span>
    <span class="c">#...</span>
    <span class="n">__acl__</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s">'view'</span><span class="p">),</span>
               <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s">'group:editors'</span><span class="p">,</span> <span class="s">'edit'</span><span class="p">)]</span>
</pre>
<p class="incremental">An ACL is a list of Access Control Entries</p>
<p class="incremental">Each ACE is a tuple of <em>action</em>, <em>principal</em> and <em>permission</em></p>
</div>
<div class="slide" id="require-permission">
<h1>Require Permission</h1>
<p>In order to match, an ACE must <em>Allow</em> the current <em>principal</em> the required
<em>permission</em></p>
<p class="incremental">Our <tt class="docutils literal">views</tt> are responsible for saying what <em>permission</em> is required</p>
<pre class="code python incremental small literal-block">
<span class="c"># for the view_page() view:</span>
<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">'.models.Page'</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s">'templates/view.pt'</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="s">'view'</span><span class="p">)</span>

<span class="c"># for add_page() and edit_page()</span>
<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s">'&lt;name&gt;'</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s">'templates/edit.pt'</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="s">'edit'</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="provide-login-logout">
<h1>Provide Login/Logout</h1>
<p>We need to allow users a way to log in and out.  Start with the views:</p>
<pre class="code python small literal-block">
<span class="c"># add imports to views.py</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">forbidden_view_config</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">remember</span><span class="p">,</span> <span class="n">forget</span>
<span class="kn">from</span> <span class="nn">wikitutorial.security</span> <span class="kn">import</span> <span class="n">USERS</span>

<span class="c"># and a logout view:</span>
<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">'.models.Wiki'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'logout'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">forget</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
                     <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</pre>
<p class="incremental">Next, add the login view</p>
</div>
<div class="slide" id="the-login-view">
<h1>The Login View</h1>
<pre class="code python tiny literal-block">
<span class="nd">&#64;view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">'.models.Wiki'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'login'</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s">'templates/login.pt'</span><span class="p">)</span>
<span class="nd">&#64;forbidden_view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s">'templates/login.pt'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s">'login'</span><span class="p">)</span>
    <span class="n">referrer</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
    <span class="k">if</span> <span class="n">referrer</span> <span class="o">==</span> <span class="n">login_url</span><span class="p">:</span>
        <span class="n">referrer</span> <span class="o">=</span> <span class="s">'/'</span> <span class="c"># never use the login form itself as came_from</span>
    <span class="n">came_from</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'came_from'</span><span class="p">,</span> <span class="n">referrer</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">login</span> <span class="o">=</span> <span class="n">password</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">if</span> <span class="s">'form.submitted'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">login</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'login'</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'password'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">USERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">came_from</span><span class="p">,</span>
                             <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">'Failed login'</span>

    <span class="n">ctxt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">came_from</span><span class="o">=</span><span class="n">came_from</span><span class="p">,</span>
                <span class="n">login</span><span class="o">=</span><span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">application_url</span> <span class="o">+</span> <span class="s">'/login'</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">ctxt</span>
</pre>
</div>
<div class="slide" id="the-login-template">
<h1>The Login Template</h1>
<p>Add <tt class="docutils literal">login.pt</tt> to the <tt class="docutils literal">templates</tt> directory</p>
<pre class="code xml small literal-block">
<span class="nt">&lt;metal:main</span> <span class="na">use-macro=</span><span class="s">&quot;load: base.pt&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;metal:pagename</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;page-name&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;b&gt;</span>Login<span class="nt">&lt;/b&gt;&lt;br/&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">tal:replace=</span><span class="s">&quot;message&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/metal:pagename&gt;</span>
  <span class="nt">&lt;metal:login</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;login&quot;</span><span class="nt">&gt;&lt;/metal:login&gt;</span>
  <span class="nt">&lt;metal:content</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;main-content&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;${url}&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;came_from&quot;</span> <span class="na">value=</span><span class="s">&quot;${came_from}&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;login&quot;</span> <span class="na">value=</span><span class="s">&quot;${login}&quot;</span><span class="nt">/&gt;&lt;br/&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span>
             <span class="na">value=</span><span class="s">&quot;${password}&quot;</span><span class="nt">/&gt;&lt;br/&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form.submitted&quot;</span> <span class="na">value=</span><span class="s">&quot;Log In&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
  <span class="nt">&lt;/metal:content&gt;</span>
<span class="nt">&lt;/metal:main&gt;</span>
</pre>
</div>
<div class="slide" id="unblock-logout-link">
<h1>Unblock Logout Link</h1>
<p>All along, we've had a logout link in our <tt class="docutils literal">base.pt</tt></p>
<p class="incremental">But we've been blocking it from showing in our templates.</p>
<p class="incremental">Let's allow it to show in the <tt class="docutils literal">view.pt</tt> and <tt class="docutils literal">edit.pt</tt> templates:</p>
<pre class="code xml small incremental literal-block">
<span class="c">&lt;!-- Delete This Line --&gt;</span>
<span class="nt">&lt;metal:login</span> <span class="na">metal:fill-slot=</span><span class="s">&quot;login&quot;</span><span class="nt">&gt;&lt;/metal:login&gt;</span>
</pre>
</div>
<div class="slide" id="conditional-logout">
<h1>Conditional Logout</h1>
<p>Look at <tt class="docutils literal">base.pt</tt>:</p>
<pre class="code xml small literal-block">
<span class="nt">&lt;metal:login</span> <span class="na">define-slot=</span><span class="s">&quot;login&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;span</span> <span class="na">tal:condition=</span><span class="s">&quot;logged_in&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${request.application_url}/logout&quot;</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/metal:login&gt;</span>
</pre>
<p class="incremental">Showing the 'logout' link is dependent on <tt class="docutils literal">logged_in</tt></p>
<p class="incremental">We have to make sure that this boolean flag is in the template context</p>
</div>
<div class="slide" id="add-logged-in-flag">
<h1>Add logged_in Flag</h1>
<p>Back in <tt class="docutils literal">views.py</tt> add the following import:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">authenticated_userid</span>
</pre>
<p class="incremental">This will return the id of the authenticated user, or None.</p>
<div class="incremental container">
<p>Add this to all return contexts for our views (except <tt class="docutils literal">login</tt>):</p>
<pre class="code python small literal-block">
<span class="n">logged_in</span> <span class="o">=</span> <span class="n">authenticated_userid</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</pre>
</div>
</div>
<div class="slide" id="check-your-work">
<h1>Check Your Work</h1>
<pre class="small literal-block">
(pyramidenv)$ python setup.py test
...
test_anonymous_user_cannot_add (wikitutorial.tests.FunctionalTests) ... ok
test_anonymous_user_cannot_edit (wikitutorial.tests.FunctionalTests) ... ok
test_editors_member_user_can_add (wikitutorial.tests.FunctionalTests) ... ok
test_editors_member_user_can_edit (wikitutorial.tests.FunctionalTests) ... ok
test_editors_member_user_can_view (wikitutorial.tests.FunctionalTests) ... ok
test_failed_log_in (wikitutorial.tests.FunctionalTests) ... ok
test_successful_log_in (wikitutorial.tests.FunctionalTests) ... ok
test_viewer_user_cannot_add (wikitutorial.tests.FunctionalTests) ... ok
test_viewer_user_cannot_edit (wikitutorial.tests.FunctionalTests) ... ok
...
----------------------------------------------------------------------
Ran 18 tests in 1.143s

OK
</pre>
</div>
<div class="slide" id="reap-the-reward">
<h1>Reap the Reward</h1>
<p>Check your work in a browser:</p>
<pre class="small literal-block">
(pyramidenv)$ pserve development.ini
Starting server in PID 36414.
serving on http://0.0.0.0:6543
</pre>
<p class="incremental">Visit <a class="reference external" href="http://localhost:6543">http://localhost:6543</a> and play for a bit</p>
</div>
<div class="slide" id="next-steps">
<h1>Next Steps</h1>
<p>We've got a workable basic wiki here, but there are some improvements that
could be nice:</p>
<ul class="incremental simple">
<li>Make the add_page view show &quot;Adding &lt;NewPage&gt;&quot; in the header without
creating a new template</li>
<li>Improve messaging to let users know when they've saved or created a page.</li>
<li>Make the link that says &quot;You can return to the FrontPage&quot; disappear when you
are viewing the front page.</li>
<li>Improve security by forcing the edit_page and add_page views <strong>only</strong> change
data on POST.</li>
<li>Improve the security model a bit: 'viewers' can add pages, and retain the
ability to edit pages they created.</li>
</ul>
</div>
<div class="slide" id="closing-up">
<h1>Closing Up</h1>
<p>But all that's for another time.</p>
<p class="incremental">For this session, we are done.</p>
</div>
</div>
</body>
</html>
