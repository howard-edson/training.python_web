<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Internet Programming with Python</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Internet Programming with Python</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Internet Programming with Python</h1>

<img alt="img/django-pony.png" class="align-left" src="img/django-pony.png" style="width: 50%;" />
<p>Session 8: A Django Application</p>
<p class="intro-blurb right">Wherein we complete our Django blog app.</p>
<p class="image-credit">image: <a class="reference external" href="http://djangopony.com/">http://djangopony.com/</a></p>

</div>
<div class="slide" id="where-we-stand">
<h1>Where We Stand</h1>
<p>We've created a couple of models, Post and Category, that make up our blog
app.</p>
<p class="incremental">We've taken some time to get familiar with the basic workings of the Django
ORM.</p>
<p class="incremental">We've made a minor modification to our model classes and written tests for it.</p>
<p class="incremental">And we've installed the Django Admin site and added our app to it.</p>
</div>
<div class="slide" id="customizing-the-admin">
<h1>Customizing the Admin</h1>
<p>We have noted, however, that the admin isn't exactly right for our needs.</p>
<ul class="incremental simple">
<li>Listing of posts should show created, modified and published dates</li>
<li>Listing of posts should show the author of a post, with a link to the author</li>
<li>It should be possible to add a post to a category while creating or editing
it</li>
</ul>
<p class="incremental small center"><a class="reference external" href="https://docs.djangoproject.com/en/1.5/ref/contrib/admin/">https://docs.djangoproject.com/en/1.5/ref/contrib/admin/</a></p>
</div>
<div class="slide" id="the-modeladmin-class">
<h1>The ModelAdmin Class</h1>
<p>Open <tt class="docutils literal">admin.py</tt> from your <tt class="docutils literal">myblog</tt> package.</p>
<ul class="incremental simple">
<li>The <tt class="docutils literal">admin.site</tt> is a globally available instance of the <tt class="docutils literal">Admin</tt> class.</li>
<li>It is initialized at runtime automatically.</li>
<li>It stores a registry of the models that are registered with it.</li>
<li>Each call to <tt class="docutils literal">admin.site.register</tt> adds a new model to the global <em>site</em>.</li>
<li><tt class="docutils literal">register</tt> takes two args: a <em>Model</em> subclass and an optional <em>ModelAdmin</em> subclass</li>
<li>If you call it without the optional subclass, you get the default.</li>
</ul>
<p class="incremental">Most usable admin functions are provided by the ModelAdmin.</p>
</div>
<div class="slide" id="custom-modeladmin">
<h1>Custom ModelAdmin</h1>
<p>Our first task is to list date and author information.</p>
<div class="incremental container">
<p>In <tt class="docutils literal">admin.py</tt> add the following code ():</p>
<pre class="code python small literal-block">
<span class="c"># this is new</span>
<span class="k">class</span> <span class="nc">PostAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'__unicode__'</span><span class="p">,</span> <span class="s">'created_date'</span><span class="p">,</span> <span class="s">'modified_date'</span><span class="p">,</span>
                    <span class="s">'published_date'</span><span class="p">,</span> <span class="s">'author'</span><span class="p">)</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">PostAdmin</span><span class="p">)</span> <span class="c">#&lt;- update this registration</span>
</pre>
</div>
<p class="incremental">Let's see what that did.</p>
</div>
<div class="slide" id="view-the-results">
<h1>View The Results</h1>
<p>If you haven't already, activate your virtualenv then fire up the development
server:</p>
<pre class="literal-block">
(djangoenv)$ python manage.py runserver
</pre>
<p class="incremental">Load <a class="reference external" href="http://localhost:8000/admin">http://localhost:8000/admin</a> and click through to the Post admin.</p>
<p class="incremental">Pretty simple, eh?</p>
</div>
<div class="slide" id="list-display">
<h1>List Display</h1>
<p>A Couple of things about the <tt class="docutils literal">list_display</tt> option are important to know:</p>
<ul class="incremental simple">
<li>The value you provide must be an iterable even if it has only one item</li>
<li>Each item in the iterable becomes a column in the list</li>
<li>The first item is the one that links to the change page for that object<ul>
<li>That can be customized by the <tt class="docutils literal">list_display_links</tt> option</li>
</ul>
</li>
<li>Listed items can be field names or callables.</li>
<li>Callables can be module-level functions, or methods on the ModelAdmin or
Model</li>
</ul>
</div>
<div class="slide" id="a-better-author-listing">
<h1>A Better Author Listing</h1>
<p>Let's use this last bit to fix the author listing.</p>
<p class="incremental">We'll need functionality that provides:</p>
<ul class="incremental simple">
<li>The full name of the author, if present, otherwise the username.</li>
<li>A link to the admin change form for that author.</li>
</ul>
<p class="incremental">Where should this go? Module? ModelAdmin? Model?</p>
<ul class="incremental simple">
<li>The first could be useful in public listings</li>
<li>The second is really only useful on the backend</li>
</ul>
</div>
<div class="slide" id="add-tests">
<h1>Add Tests</h1>
<p>In <tt class="docutils literal">tests.py</tt> add the following test:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">PostTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c">#...</span>
    <span class="k">def</span> <span class="nf">test_author_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">fn</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">un</span> <span class="o">=</span> <span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                          <span class="n">author</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                          <span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="n">author_name</span> <span class="o">=</span> <span class="n">Post</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">)</span><span class="o">.</span><span class="n">author_name</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fn</span> <span class="ow">and</span> <span class="n">ln</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">author_name</span><span class="p">,</span> <span class="n">un</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">fn</span> <span class="ow">in</span> <span class="n">author_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ln</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ln</span> <span class="ow">in</span> <span class="n">author_name</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id1">
<h1>Add Tests</h1>
<p>To test the admin, we'll first need a new TestClass:</p>
<pre class="code python small literal-block">
<span class="c"># new imports</span>
<span class="kn">from</span> <span class="nn">django.contrib.admin.sites</span> <span class="kn">import</span> <span class="n">AdminSite</span>
<span class="kn">from</span> <span class="nn">myblog.admin</span> <span class="kn">import</span> <span class="n">PostAdmin</span>

<span class="c"># new TestCase</span>
<span class="k">class</span> <span class="nc">PostAdminTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">fixtures</span> <span class="o">=</span> <span class="p">[</span><span class="s">'myblog_test_fixture.json'</span><span class="p">,</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="n">AdminSite</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma</span> <span class="o">=</span> <span class="n">PostAdmin</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">admin</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">'s title&quot;</span> <span class="o">%</span> <span class="n">author</span><span class="o">.</span><span class="n">username</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">)</span>
            <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre>
</div>
<div class="slide" id="id2">
<h1>Add Tests</h1>
<p>And then we need a test added to it:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_author_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected_link_path</span> <span class="o">=</span> <span class="s">'/admin/auth/user/</span><span class="si">%s</span><span class="s">'</span>
    <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">expected_link_path</span> <span class="o">%</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">author_link</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">expected</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">)</span>
</pre>
<div class="incremental container">
<p>Quit the django server and run your tests:</p>
<pre class="small literal-block">
(djangoenv)$ python manage.py test myblog
...
Ran 4 tests in 0.026s
FAILED (errors=2)
</pre>
</div>
</div>
<div class="slide" id="make-them-pass">
<h1>Make Them Pass</h1>
<p>First, add the <tt class="docutils literal">author_name</tt> method to our Post model in <tt class="docutils literal">models.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">author_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">raw_name</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">raw_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span>
    <span class="k">return</span> <span class="n">name</span>
</pre>
<pre class="small incremental literal-block">
(djangoenv)$ python manage.py test myblog
...
Ran 4 tests in 0.027s
FAILED (errors=1)
</pre>
</div>
<div class="slide" id="id3">
<h1>Make Them Pass</h1>
<p>Finally, add the <tt class="docutils literal">author_link</tt> method to the PostAdmin in <tt class="docutils literal">admin.py</tt>:</p>
<pre class="code python small literal-block">
<span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="c"># and a method</span>
<span class="k">class</span> <span class="nc">PostAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="c">#...</span>
    <span class="k">def</span> <span class="nf">author_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s">'admin:auth_user_change'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">author_name</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">'&lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;'</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre>
<pre class="small incremental literal-block">
(djangoenv)$ python manage.py test myblog
...Ran 4 tests in 0.035s
OK
</pre>
</div>
<div class="slide" id="hook-it-up">
<h1>Hook It Up</h1>
<p>First, replace the <tt class="docutils literal">'author'</tt> name in <tt class="docutils literal">list_display</tt> with
<tt class="docutils literal">'author_link'</tt>:</p>
<pre class="code python small literal-block">
<span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="s">'author_link'</span><span class="p">)</span>
</pre>
<div class="incremental container">
<p>We also need to let the admin know our HTML is safe:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">author_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
    <span class="c">#... method body</span>
<span class="n">author_link</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="bp">True</span>
</pre>
</div>
</div>
<div class="slide" id="wait-what">
<h1>Wait, What??</h1>
<p>In Python, <em>everything</em> is an object. Even methods of classes.</p>
<p class="incremental">The Django admin uses special <em>method attributes</em> to control the methods you
create for <tt class="docutils literal">list_display</tt>.</p>
<div class="incremental container">
<p>Another special attribute controls the column title used in the list page:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">author_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
    <span class="c">#... method body</span>
<span class="n">author_link</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">author_link</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s">&quot;Author&quot;</span> <span class="c">#&lt;- add this</span>
</pre>
</div>
</div>
<div class="slide" id="see-the-results">
<h1>See The Results</h1>
<p>Start up the Django server again and see what you've done:</p>
<pre class="small literal-block">
(djangoenv)$ python manage.py runserver
</pre>
<p class="incremental">Reload your admin site, click on the Post admin and see the new 'Author'
column.</p>
<ul class="incremental simple">
<li>Click on an author name.</li>
<li>Set the first and last names (if you haven't already).</li>
<li>Go back to Posts and see the outcome of this change.</li>
</ul>
<p class="incremental">Not bad, eh?</p>
</div>
<div class="slide" id="categorize-posts">
<h1>Categorize Posts</h1>
<p>We'd like to be able to add categories to posts while adding or editing them.</p>
<p class="incremental">But there is no field on the <tt class="docutils literal">Post</tt> model that would show them.</p>
<p class="incremental">Django provides the concept of an <tt class="docutils literal">inline</tt> form to allow adding objects that
are related when there is no field available.</p>
<p class="incremental">In the Django Admin, these are created using subclasses of the
<tt class="docutils literal">InlineAdmin</tt>.</p>
</div>
<div class="slide" id="create-an-inline-admin">
<h1>Create an Inline Admin</h1>
<p>In <tt class="docutils literal">admin.py</tt> add the following code <em>above</em> the definition of PostAdmin:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">CategoryInlineAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">through</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="mi">1</span>
</pre>
<div class="incremental container">
<p>And then add one line to the PostAdmin class definition:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">PostAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="c">#... other options</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">CategoryInlineAdmin</span><span class="p">,</span> <span class="p">]</span>

    <span class="c">#... methods</span>
</pre>
</div>
</div>
<div class="slide" id="try-it-out">
<h1>Try It Out</h1>
<p>Restart the Django server and see what you've done:</p>
<pre class="small literal-block">
(djangoenv)$ python manage.py runserver
</pre>
<p class="incremental">Note that you can even add <em>new</em> categories via the inline form.</p>
<p class="incremental">But, in the form for a category, you see the field for Post. That shouldn't be
there.</p>
</div>
<div class="slide" id="a-final-tweak">
<h1>A Final Tweak</h1>
<p>See if you can figure out how to remove the <tt class="docutils literal">posts</tt> field from the
CategoryAdmin.</p>
<pre class="code python small incremental literal-block">
<span class="c"># create a custom model admin class</span>
<span class="k">class</span> <span class="nc">CategoryAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">(</span><span class="s">'posts'</span><span class="p">,</span> <span class="p">)</span>

<span class="c"># and register Category to use it in the Admin</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">CategoryAdmin</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="a-public-face">
<h1>A Public Face</h1>
<p>Point your browser at <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a></p>
<p class="incremental">What do you see?</p>
<p class="incremental">Why?</p>
<p class="incremental">We need to add some public pages for our blog.</p>
<p class="incremental">In Django, the code that builds a page that you can see is called a <em>view</em>.</p>
</div>
<div class="slide" id="django-views">
<h1>Django Views</h1>
<p>A <em>view</em> can be defined as a <em>callable</em> that takes a request and returns a
response.</p>
<p class="incremental">This should sound pretty familiar to you.</p>
<p class="incremental">Classically, Django views were functions.</p>
<p class="incremental">Version 1.3 added support for Class-based Views (a class with a <tt class="docutils literal">__call__</tt>
method is a callable)</p>
</div>
<div class="slide" id="a-basic-view">
<h1>A Basic View</h1>
<p>Let's add a really simple view to our app.</p>
<p class="incremental">It will be a stub for our public UI.  Add this to <tt class="docutils literal">views.py</tt> in <tt class="docutils literal">myblog</tt></p>
<pre class="code python small incremental literal-block">
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span><span class="p">,</span> <span class="n">Http404</span>

<span class="k">def</span> <span class="nf">stub_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;Stub View</span><span class="se">\n\n</span><span class="s">&quot;</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="s">&quot;Args:</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="s">&quot;Kwargs:</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s">&quot;text/plain&quot;</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="hooking-it-up">
<h1>Hooking It Up</h1>
<p>We talked in the previous session about the Django urlconf</p>
<p class="incremental">We used our project urlconf to hook the Django admin into our project.</p>
<p class="incremental">We want to do the same thing for our new app.</p>
<p class="incremental">In general, an <em>app</em> that serves any sort of views should contain its own
urlconf.</p>
<p class="incremental">The project urlconf should mainly <em>include</em> these where possible.</p>
</div>
<div class="slide" id="adding-a-urlconf">
<h1>Adding A Urlconf</h1>
<p>Create a new file <tt class="docutils literal">urls.py</tt> inside the <tt class="docutils literal">myblog</tt> app package.</p>
<div class="incremental container">
<p>Open it in your editor and add the following code:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">'myblog.views'</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span>
        <span class="s">'stub_view'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&quot;blog_index&quot;</span><span class="p">),</span>
<span class="p">)</span>
</pre>
</div>
</div>
<div class="slide" id="include-blog-urls">
<h1>Include Blog Urls</h1>
<p>In order for our new urls to load, we'll need to include them in our project
urlconf</p>
<div class="incremental container">
<p>Open <tt class="docutils literal">urls.py</tt> from the <tt class="docutils literal">mysite</tt> project package and add this:</p>
<pre class="code python small literal-block">
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">''</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'myblog.urls'</span><span class="p">)),</span> <span class="c">#&lt;- add this</span>
    <span class="c">#... other included urls</span>
<span class="p">)</span>
</pre>
</div>
<p class="incremental">Try reloading <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a></p>
<p class="incremental">You should see some output now.</p>
</div>
<div class="slide" id="a-word-on-prefixes">
<h1>A Word On Prefixes</h1>
<p>The <tt class="docutils literal">patterns</tt> function takes a first argument called the <em>prefix</em></p>
<p class="incremental">When it is not empty, it is added to any view names in <tt class="docutils literal">url()</tt> calls in the
same <tt class="docutils literal">patterns</tt>.</p>
<p class="incremental">In a root urlconf like the one in <tt class="docutils literal">mysite</tt>, this isn't too useful</p>
<p class="incremental">But in <tt class="docutils literal">myblog.urls</tt> it lets us refer to views by simple function name</p>
<p class="incremental">No need to import every view.</p>
</div>
<div class="slide" id="project-url-space">
<h1>Project URL Space</h1>
<p>A project is defined by the urls a user can visit.</p>
<p class="incremental">What should our users be able to see when they visit our blog?</p>
<ul class="incremental simple">
<li>A list view that shows blog posts, most recent first.</li>
<li>An individual post view, showing a single post (a permalink).</li>
</ul>
<p class="incremental">Let's add urls for each of these, use the stub view for now.</p>
</div>
<div class="slide" id="our-urls">
<h1>Our URLs</h1>
<p>We've already got a good url for the list page: <tt class="docutils literal">blog_index</tt> at '/'</p>
<div class="incremental container">
<p>For the view of a single post, we'll need to capture the id of the post.
Add this to <tt class="docutils literal">urlpatterns</tt>:</p>
<pre class="code python small incremental literal-block">
<span class="n">url</span><span class="p">(</span><span class="s">r'^posts/(\d+)/$'</span><span class="p">,</span>
    <span class="s">'stub_view'</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;blog_detail&quot;</span><span class="p">),</span>
</pre>
</div>
<p class="incremental"><tt class="docutils literal">(\d+)</tt> captures one or more digits as the post_id.</p>
<p class="incremental">Load <a class="reference external" href="http://localhost:8000/posts/1234/">http://localhost:8000/posts/1234/</a> and see what you get.</p>
</div>
<div class="slide" id="a-word-on-capture-in-urls">
<h1>A Word on Capture in URLs</h1>
<p>When you load the above url, you should see <tt class="docutils literal">1234</tt> listed as an <em>arg</em></p>
<div class="incremental container">
<p>Try changing the regexp like so:</p>
<pre class="code python small literal-block">
<span class="s">r'^posts/(?P&lt;post_id&gt;\d+)/$'</span>
</pre>
</div>
<p class="incremental">Reload the same url. Notice the change.</p>
<p class="incremental">How you declare a capture group in your url pattern regexp influenced how it
will be passed to the view callable.</p>
</div>
<div class="slide" id="full-urlconf">
<h1>Full Urlconf</h1>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">'myblog.views'</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span>
        <span class="s">'stub_view'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&quot;blog_index&quot;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^posts/(?P&lt;post_id&gt;\d+)/$'</span><span class="p">,</span>
        <span class="s">'stub_view'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&quot;blog_detail&quot;</span><span class="p">),</span>
<span class="p">)</span>
</pre>
</div>
<div class="slide" id="testing-views">
<h1>Testing Views</h1>
<p>Before we begin, we need to add some tests for the views we are about to
create.</p>
<p class="incremental">We'll need tests for a list view and a detail view</p>
<p class="incremental">To save us time, I've written these tests already</p>
<p class="incremental">You can find them in the class resources directory: <tt class="docutils literal">blog_view_tests.py</tt></p>
<p class="incremental">Copy the contents of that file into our blog <tt class="docutils literal">tests.py</tt> file.</p>
</div>
<div class="slide" id="run-the-tests">
<h1>Run The Tests</h1>
<pre class="literal-block">
(djangoenv)$ python manage.py test myblog
...
----------------------------------------------------------------------
Ran 7 tests in 0.478s

FAILED (failures=2)
Destroying test database for alias 'default'...
</pre>
</div>
<div class="slide" id="our-first-view">
<h1>Our First View</h1>
<p>Add the view for listing blog posts to <tt class="docutils literal">views.py</tt>.</p>
<pre class="code python small literal-block">
<span class="c"># add these imports</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span><span class="p">,</span> <span class="n">loader</span>
<span class="kn">from</span> <span class="nn">myblog.models</span> <span class="kn">import</span> <span class="n">Post</span>

<span class="c"># and this view</span>
<span class="k">def</span> <span class="nf">list_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">published</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">published_date__exact</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">published</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-published_date'</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">'list.html'</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'posts'</span><span class="p">:</span> <span class="n">posts</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s">&quot;text/html&quot;</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="getting-posts">
<h1>Getting Posts</h1>
<pre class="code python small literal-block">
<span class="n">published</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">published_date__exact</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">posts</span> <span class="o">=</span> <span class="n">published</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-published_date'</span><span class="p">)</span>
</pre>
<p class="incremental">We begin by using the QuerySet API to fetch all the posts that have
<tt class="docutils literal">published_date</tt> set</p>
<p class="incremental">Using the chaining nature of the API we order these posts by
<tt class="docutils literal">published_date</tt></p>
<p class="incremental">Remember, at this point, no query has actually been issued to the database.</p>
</div>
<div class="slide" id="getting-a-template">
<h1>Getting a Template</h1>
<pre class="code python small literal-block">
<span class="n">template</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">'list.html'</span><span class="p">)</span>
</pre>
<p class="incremental">Django uses configuration to determine how to find templates.</p>
<p class="incremental">By default, Django looks in installed <em>apps</em> for a <tt class="docutils literal">templates</tt> directory</p>
<p class="incremental">It also provides a place to list specific directories.</p>
<p class="incremental">Let's set that up in <tt class="docutils literal">settings.py</tt></p>
</div>
<div class="slide" id="project-templates">
<h1>Project Templates</h1>
<p>In <tt class="docutils literal">settings.py</tt> find <tt class="docutils literal">TEMPLATE_DIRS</tt> and add the absolute path to your
<tt class="docutils literal">mysite</tt> project package:</p>
<pre class="code python small literal-block">
<span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="p">(</span><span class="s">'/absolute/path/to/mysite/mysite/templates'</span><span class="p">,</span> <span class="p">)</span>
</pre>
<p class="incremental">Then add a <tt class="docutils literal">templates</tt> directory to your <tt class="docutils literal">mysite</tt> project package</p>
<p class="incremental">Finally, in that directory add a new file <tt class="docutils literal">base.html</tt> and populate it with
the following:</p>
</div>
<div class="slide" id="base-html">
<h1>base.html</h1>
<pre class="code jinja small literal-block">
<span class="x">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Django Blog&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;container&quot;&gt;
      &lt;div id=&quot;content&quot;&gt;
      </span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x">
       [content will go here]
      </span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x">
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</span>
</pre>
</div>
<div class="slide" id="templates-in-django">
<h1>Templates in Django</h1>
<p>Before we move on, a quick word about Django templates.</p>
<p class="incremental">We've seen Jinja2 which was &quot;inspired by Django's templating system&quot;.</p>
<p class="incremental">Basically, you already know how to write Django templates.</p>
<p class="incremental">Django templates <strong>do not</strong> allow any python expressions.</p>
<p class="incremental center small"><a class="reference external" href="https://docs.djangoproject.com/en/1.5/ref/templates/builtins/">https://docs.djangoproject.com/en/1.5/ref/templates/builtins/</a></p>
</div>
<div class="slide" id="blog-templates">
<h1>Blog Templates</h1>
<p>Our view tries to load <tt class="docutils literal">list.html</tt>.</p>
<p class="incremental">This template is probably specific to the blog functionality of our site</p>
<p class="incremental">It is common to keep shared templates in your project directory and
specialized ones in app directories.</p>
<p class="incremental">Add a <tt class="docutils literal">templates</tt> directory to your <tt class="docutils literal">myblog</tt> app, too.</p>
<p class="incremental">In it, create a new file <tt class="docutils literal">list.html</tt> and add this:</p>
</div>
<div class="slide" id="list-html">
<h1>list.html</h1>
<pre class="code jinja tiny literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span><span class="x">

</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x">
  &lt;h1&gt;Recent Posts&lt;/h1&gt;

  </span><span class="cp">{%</span> <span class="k">comment</span> <span class="cp">%}</span><span class="c"> here is where the query happens </span><span class="cp">{%</span> <span class="k">endcomment</span> <span class="cp">%}</span><span class="x">
  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">posts</span> <span class="cp">%}</span><span class="x">
  &lt;div class=&quot;post&quot;&gt;
    &lt;h2&gt;</span><span class="cp">{{</span> <span class="nv">post</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;
    &lt;p class=&quot;byline&quot;&gt;
      Posted by </span><span class="cp">{{</span> <span class="nv">post.author_name</span> <span class="cp">}}</span><span class="x"> &amp;mdash; </span><span class="cp">{{</span> <span class="nv">post.published_date</span> <span class="cp">}}</span><span class="x">
    &lt;/p&gt;
    &lt;div class=&quot;post-body&quot;&gt;
      </span><span class="cp">{{</span> <span class="nv">post.text</span> <span class="cp">}}</span><span class="x">
    &lt;/div&gt;
    &lt;ul class=&quot;categories&quot;&gt;
      </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">category</span> <span class="k">in</span> <span class="nv">post.categories.all</span> <span class="cp">%}</span><span class="x">
        &lt;li&gt;</span><span class="cp">{{</span> <span class="nv">category</span> <span class="cp">}}</span><span class="x">&lt;/li&gt;
      </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
    &lt;/ul&gt;
  &lt;/div&gt;
  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="template-context">
<h1>Template Context</h1>
<pre class="code python small literal-block">
<span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span>
    <span class="s">'posts'</span><span class="p">:</span> <span class="n">posts</span><span class="p">,</span>
<span class="p">})</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</pre>
<p class="incremental">Like Jinja2, django templates are rendered by passing in a <em>context</em></p>
<p class="incremental">Django's RequestContext provides common bits, similar to the global context in
Flask</p>
<p class="incremental">We add our posts to that context so they can be used by the template.</p>
</div>
<div class="slide" id="return-a-response">
<h1>Return a Response</h1>
<pre class="code python small literal-block">
<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s">&quot;text/html&quot;</span><span class="p">)</span>
</pre>
<p class="incremental">Finally, we build an HttpResponse and return it.</p>
<p class="incremental">This is, fundamentally, no different from the <tt class="docutils literal">stub_view</tt> just above.</p>
</div>
<div class="slide" id="fix-urls">
<h1>Fix URLs</h1>
<p>We need to fix the url for our blog index page</p>
<div class="incremental container">
<p>Update <tt class="docutils literal">urls.py</tt> in <tt class="docutils literal">myblog</tt>:</p>
<pre class="code python small literal-block">
<span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span>
    <span class="s">'list_view'</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;blog_index&quot;</span><span class="p">),</span>
</pre>
</div>
<pre class="incremental small literal-block">
(djangoenv)$ python manage.py test myblog
...
Ran 7 tests in 0.494s
FAILED (failures=1)
</pre>
</div>
<div class="slide" id="common-patterns">
<h1>Common Patterns</h1>
<p>This is a common pattern in Django views:</p>
<ul class="incremental simple">
<li>get a template from the loader</li>
<li>build a context, usually using a RequestContext</li>
<li>render the template</li>
<li>return an HttpResponse</li>
</ul>
<p class="incremental">So common in fact that Django provides two shortcuts for us to use:</p>
<ul class="incremental simple">
<li><tt class="docutils literal">render(request, template[, <span class="pre">ctx][,</span> ctx_instance])</tt></li>
<li><tt class="docutils literal">render_to_response(template[, <span class="pre">ctx][,</span> ctx_instance])</tt></li>
</ul>
</div>
<div class="slide" id="shorten-our-view">
<h1>Shorten Our View</h1>
<p>Let's replace most of our view with the <tt class="docutils literal">render</tt> shortcut</p>
<pre class="code python small literal-block">
<span class="c"># replace RequestContext and loader import</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="c"># rewrite our view</span>
<span class="k">def</span> <span class="nf">list_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">published</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">published_date__exact</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">published</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-published_date'</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">posts</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'list.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre>
<p class="incremental">Remember though, all we did manually before is still happening</p>
</div>
<div class="slide" id="detail-view">
<h1>Detail View</h1>
<p>Next, let's write a view function for the detail view of a post</p>
<div class="incremental container">
<p>It should have the following signature:</p>
<pre class="code python small literal-block">
<span class="n">detail_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">post_id</span><span class="p">)</span>
</pre>
</div>
<p class="incremental">We will call the template <tt class="docutils literal">detail.html</tt></p>
<p class="incremental">Let's start with the code in <tt class="docutils literal">views.py</tt></p>
</div>
<div class="slide" id="id4">
<h1>detail_view</h1>
<pre class="code python incremental small literal-block">
<span class="k">def</span> <span class="nf">detail_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">post_id</span><span class="p">):</span>
    <span class="n">published</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">published_date__exact</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">published</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Post</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">'post'</span><span class="p">:</span> <span class="n">post</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'detail.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre>
<p class="incremental">All models raise a DoesNotExist exception if <tt class="docutils literal">get</tt> returns nothing.</p>
<p class="incremental">We can use that fact to raise a Not Found exception.</p>
<p class="incremental">Django will handle the rest for us.</p>
</div>
<div class="slide" id="detail-html">
<h1>detail.html</h1>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span><span class="x">

</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x">
&lt;a class=&quot;backlink&quot; href=&quot;/&quot;&gt;Home&lt;/a&gt;
&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">post</span> <span class="cp">}}</span><span class="x">&lt;/h1&gt;
&lt;p class=&quot;byline&quot;&gt;
  Posted by </span><span class="cp">{{</span> <span class="nv">post.author_name</span> <span class="cp">}}</span><span class="x"> &amp;mdash; </span><span class="cp">{{</span> <span class="nv">post.published_date</span> <span class="cp">}}</span><span class="x">
&lt;/p&gt;
&lt;div class=&quot;post-body&quot;&gt;
  </span><span class="cp">{{</span> <span class="nv">post.text</span> <span class="cp">}}</span><span class="x">
&lt;/div&gt;
&lt;ul class=&quot;categories&quot;&gt;
  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">category</span> <span class="k">in</span> <span class="nv">post.categories.all</span> <span class="cp">%}</span><span class="x">
    &lt;li&gt;</span><span class="cp">{{</span> <span class="nv">category</span> <span class="cp">}}</span><span class="x">&lt;/li&gt;
  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
&lt;/ul&gt;
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="id5">
<h1>Hook it Up</h1>
<p>In order to view a single post, we'll need a link from the list view</p>
<div class="incremental container">
<p>We can use the <tt class="docutils literal">url</tt> template tag (like flask url_for):</p>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">url</span> <span class="s1">'&lt;view_name&gt;'</span> <span class="nv">arg1</span> <span class="nv">arg2</span> <span class="cp">%}</span>
</pre>
</div>
<p class="incremental">In our <tt class="docutils literal">list.html</tt> template, let's link the post titles:</p>
<pre class="code jinja small incremental literal-block">
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">posts</span> <span class="cp">%}</span><span class="x">
&lt;div class=&quot;post&quot;&gt;
  &lt;h2&gt;
    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">'blog_detail'</span> <span class="nv">post.pk</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;
  &lt;/h2&gt;
  ...</span>
</pre>
</div>
<div class="slide" id="id6">
<h1>Fix URLs</h1>
<p>Again, we need to insert our new view into the existing <tt class="docutils literal">urls.py</tt> in
<tt class="docutils literal">myblog</tt>:</p>
<pre class="code python small literal-block">
<span class="n">url</span><span class="p">(</span><span class="s">r'^posts/(?P&lt;post_id&gt;\d+)/$'</span><span class="p">,</span>
    <span class="s">'detail_view'</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;blog_detail&quot;</span><span class="p">),</span>
</pre>
<pre class="incremental small literal-block">
(djangoenv)$ python manage.py test myblog
...
Ran 7 tests in 0.513s
OK
</pre>
</div>
<div class="slide" id="a-moment-to-play">
<h1>A Moment To Play</h1>
<p>We've got some good stuff to look at now.  Fire up the server</p>
<p class="incremental">Reload your blog index page and click around a bit.</p>
<p class="incremental">You can now move back and forth between list and detail view.</p>
<p class="incremental">Try loading the detail view for a post that doesn't exist</p>
</div>
<div class="slide" id="congratulations">
<h1>Congratulations</h1>
<p>You've got a functional Blog</p>
<p class="incremental">It's not very pretty, though.</p>
<p class="incremental">We can fix that by adding some css</p>
<p class="incremental">This gives us a chance to learn about Django's handling of <em>static files</em></p>
</div>
<div class="slide" id="static-files">
<h1>Static Files</h1>
<p>Like templates, Django expects to find static files in particular locations</p>
<p class="incremental">It will look for them in a directory named <tt class="docutils literal">static</tt> in any installed apps.</p>
<p class="incremental">They will be served from the url path in the STATIC_URL setting.</p>
<p class="incremental">By default, this is <tt class="docutils literal">/static/</tt></p>
</div>
<div class="slide" id="add-css">
<h1>Add CSS</h1>
<p>I've prepared a css file for us to use. You can find it in the class resources</p>
<p class="incremental">Create a new directory <tt class="docutils literal">static</tt> in the <tt class="docutils literal">myblog</tt> app.</p>
<p class="incremental">Copy the <tt class="docutils literal">django_css</tt> file into that new directory.</p>
<div class="incremental container">
<p>Then add this link to the &lt;head&gt; of <tt class="docutils literal">base.html</tt>:</p>
<pre class="code html small literal-block">
<span class="nt">&lt;title&gt;</span>My Django Blog<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/static/django_blog.css&quot;</span><span class="nt">&gt;</span>
</pre>
</div>
</div>
<div class="slide" id="view-your-results">
<h1>View Your Results</h1>
<p>Reload <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a> and view the results of your work</p>
<p class="incremental">We now have a reasonable view of the posts of our blog on the front end</p>
<p class="incremental">And we have a way to create and categorize posts using the admin</p>
<p class="incremental">However, we lack a way to move between the two.</p>
<p class="incremental">Let's add that ability next.</p>
</div>
<div class="slide" id="adding-a-control-bar">
<h1>Adding A Control Bar</h1>
<p>We'll start by adding a control bar to our <tt class="docutils literal">base.html</tt> template:</p>
<pre class="code jinja small literal-block">
<span class="x">&lt;!DOCTYPE html&gt;
  ...
    &lt;div id=&quot;header&quot;&gt;
      &lt;ul id=&quot;control-bar&quot;&gt;
      </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.is_authenticated</span> <span class="cp">%}</span><span class="x">
        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.is_admin</span> <span class="cp">%}</span><span class="x">&lt;li&gt;admin&lt;/li&gt;</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">
        &lt;li&gt;logout&lt;/li&gt;
      </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x">
        &lt;li&gt;login&lt;/li&gt;
      </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">
      &lt;/ul&gt;
    &lt;/div&gt;
    &lt;div id=&quot;container&quot;&gt;
      ...</span>
</pre>
</div>
<div class="slide" id="request-context-revisited">
<h1>Request Context Revisited</h1>
<p>When we set up our views, we used the <tt class="docutils literal">render</tt> shortcut, which provides a
<tt class="docutils literal">RequestContext</tt></p>
<p class="incremental">This gives us access to <tt class="docutils literal">user</tt> in our templates</p>
<p class="incremental">It provides access to methods about the state and rights of that user</p>
<p class="incremental">We can use these to conditionally display links or UI elements.</p>
</div>
<div class="slide" id="login-logout">
<h1>Login/Logout</h1>
<p>Django provides a reasonable set of views for login/logout.</p>
<p class="incremental">The first step to using them is to hook them into a urlconf.</p>
<div class="incremental container">
<p>Add the following to <tt class="docutils literal">mysite/urls.py</tt>:</p>
<pre class="code python small literal-block">
<span class="n">url</span><span class="p">(</span><span class="s">r'^'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'myblog.urls'</span><span class="p">)),</span> <span class="c">#&lt;- already there</span>
<span class="n">url</span><span class="p">(</span><span class="s">r'^login/$'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth.views.login'</span><span class="p">,</span>
    <span class="p">{</span><span class="s">'template_name'</span><span class="p">:</span> <span class="s">'login.html'</span><span class="p">},</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;login&quot;</span><span class="p">),</span>
<span class="n">url</span><span class="p">(</span><span class="s">r'^logout/$'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth.views.logout'</span><span class="p">,</span>
    <span class="p">{</span><span class="s">'next_page'</span><span class="p">:</span> <span class="s">'/'</span><span class="p">},</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;logout&quot;</span><span class="p">),</span>
</pre>
</div>
</div>
<div class="slide" id="login-template">
<h1>Login Template</h1>
<p>We need to create a new <tt class="docutils literal">login.html</tt> template in <tt class="docutils literal">mysite/templates</tt>:</p>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span><span class="x">

</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x">
&lt;h1&gt;My Blog Login&lt;/h1&gt;
&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;</span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span><span class="x">
  </span><span class="cp">{{</span> <span class="nv">form.as_p</span> <span class="cp">}}</span><span class="x">
  &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;Log In&quot;&gt;&lt;/p&gt;
&lt;/form&gt;
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="submitting-forms">
<h1>Submitting Forms</h1>
<p>In a web application, submitting forms is potentially hazardous</p>
<p class="incremental">Data is being sent to our application from some remote place</p>
<p class="incremental">If that data is going to alter the state of our application, we <strong>must</strong> use
POST</p>
<p class="incremental">Even so, we are vulnerable to Cross-Site Request Forgery, a common attack
vector.</p>
</div>
<div class="slide" id="danger-csrf">
<h1>Danger: CSRF</h1>
<p>Django provides a convenient system to fight this.</p>
<p class="incremental">In fact, for POST requests, it <em>requires</em> that you use it.</p>
<p class="incremental">The Django middleware that does this is enabled by default.</p>
<p class="incremental">All you need to do is include the <tt class="docutils literal">{% csrf_token %}</tt> tag in your form.</p>
</div>
<div class="slide" id="id7">
<h1>Hooking It Up</h1>
<p>In <tt class="docutils literal">base.html</tt> make the following updates:</p>
<pre class="code jinja small literal-block">
<span class="x">&lt;!-- admin link --&gt;
&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">'admin:index'</span> <span class="cp">%}</span><span class="x">&quot;&gt;admin&lt;/a&gt;
&lt;!-- logout link --&gt;
&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">'logout'</span> <span class="cp">%}</span><span class="x">&quot;&gt;logout&lt;/a&gt;
&lt;!-- login link --&gt;
&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">'login'</span> <span class="cp">%}</span><span class="x">&quot;&gt;login&lt;/a&gt;</span>
</pre>
<div class="incremental container">
<p>Finally, in <tt class="docutils literal">settings.py</tt> add the following:</p>
<pre class="code python small literal-block">
<span class="n">LOGIN_URL</span> <span class="o">=</span> <span class="s">'/login/'</span>
<span class="n">LOGIN_REDIRECT_URL</span> <span class="o">=</span> <span class="s">'/'</span>
</pre>
</div>
</div>
<div class="slide" id="handling-forms">
<h1>Handling Forms</h1>
<p>Adding login and logout has given us a sneak peek at forms.</p>
<p class="incremental">But there is a <em>lot</em> of magic happening that we should see directly.</p>
<p class="incremental">As a last task, let's add a non-admin way to create new posts.</p>
<p class="incremental">We'll use a form, submit it to a view, and have it create a new Post object</p>
</div>
<div class="slide" id="django-forms">
<h1>Django Forms</h1>
<p>Forms are, like Models, a Django <em>class</em></p>
<p class="incremental">Like Models, you add fields to a form as class <em>attributes</em></p>
<p class="incremental">Like Model fields, the fields on a form are also Python class instances.</p>
<p class="incremental">Unlike Model fields, Form fields are built to interact with data in a
<em>request</em></p>
<p class="incremental">By tradition, they are created in a module called <tt class="docutils literal">forms.py</tt></p>
</div>
<div class="slide" id="post-form">
<h1>Post Form</h1>
<p>Create <tt class="docutils literal">forms.py</tt> in <tt class="docutils literal">myblog</tt> and open it in your editor.</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">myblog.models</span> <span class="kn">import</span> <span class="n">Post</span>

<span class="k">class</span> <span class="nc">PostForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'title'</span><span class="p">,</span> <span class="s">'text'</span><span class="p">,</span> <span class="s">'author'</span><span class="p">)</span>
</pre>
<p class="incremental">The <tt class="docutils literal">ModelForm</tt> class generates fields based on the model.</p>
<p class="incremental">Use <tt class="docutils literal">fields</tt> to force only a subset of those.</p>
</div>
<div class="slide" id="a-view-for-our-form">
<h1>A View for Our Form</h1>
<p>The basic approach to handling forms in Django always follows this pattern:</p>
<pre class="code python small literal-block">
<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
    <span class="c"># bind a form instance to POST data</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="c"># process the form data here</span>
        <span class="c"># tell the user about the success</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># tell the user about the problem</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c"># create an unbound form</span>
<span class="c"># render the form template</span>
</pre>
<p class="incremental">Let's create a <tt class="docutils literal">add_post</tt> view that does this with our <tt class="docutils literal">PostForm</tt></p>
</div>
<div class="slide" id="add-post-view">
<h1>add_post view</h1>
<pre class="code python small literal-block">
<span class="c"># add imports to views.py</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">PermissionDenied</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">myblog.forms</span> <span class="kn">import</span> <span class="n">PostForm</span>

<span class="c"># and a new view function:</span>
<span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PostForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="c"># handle form submission</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PostForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">'form'</span><span class="p">:</span> <span class="n">form</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'add.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="add-a-url">
<h1>Add A URL</h1>
<p>In <tt class="docutils literal">myblog/urls.py</tt> add a new entry to our urlconf:</p>
<pre class="code python small literal-block">
<span class="n">url</span><span class="p">(</span><span class="s">r'^add/$'</span><span class="p">,</span>
    <span class="s">'add_view'</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&quot;add_post&quot;</span><span class="p">),</span>
</pre>
<div class="incremental container">
<p>And hook it up to the control bar link in <tt class="docutils literal">base.html</tt></p>
<pre class="code jinja literal-block">
<span class="x">&lt;!-- update new post link --&gt;
&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">'add_post'</span> <span class="cp">%}</span><span class="x">&quot;&gt;new post&lt;/a&gt;</span>
</pre>
</div>
</div>
<div class="slide" id="create-add-html">
<h1>Create add.html</h1>
<p>Finally, we need to create a template, <tt class="docutils literal">add.html</tt> in <tt class="docutils literal">myblog/templates</tt>:</p>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span><span class="x">

</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x">
&lt;h1&gt;New Blog Post&lt;/h1&gt;
&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;</span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span><span class="x">
  </span><span class="cp">{{</span> <span class="nv">form.as_p</span> <span class="cp">}}</span><span class="x">
  &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;Save&quot;&gt;&lt;/p&gt;
&lt;/form&gt;
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="id8">
<h1>Try it Out</h1>
<p>You should be able to click on the 'new post' button in the control bar.</p>
<p class="incremental">How does the form look?</p>
<p class="incremental">It would be nice if the 'author' field were auto-populated, and even hidden.</p>
<p class="incremental">Let's do that next.</p>
</div>
<div class="slide" id="form-initial">
<h1>Form 'initial'</h1>
<p>When instantiating a form, you can pass it <em>initial</em> values.</p>
<div class="incremental container">
<p>In <tt class="docutils literal">views.py</tt> make the following changes to the <tt class="docutils literal">add_view</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="c">#... not quite ready for this yet.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="p">{</span><span class="s">'author'</span><span class="p">:</span> <span class="n">user</span><span class="p">}</span> <span class="c">#&lt;- add this</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PostForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">)</span> <span class="c">#&lt;- updated</span>
</pre>
</div>
</div>
<div class="slide" id="hidden-fields">
<h1>Hidden Fields</h1>
<p>If you reload, you should now see <tt class="docutils literal">author</tt> pre-popluated.</p>
<div class="incremental container">
<p>To hide it, we must update the 'widget' it will use in <tt class="docutils literal">forms.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">class</span> <span class="nc">PostForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="c">#...</span>
        <span class="n">widgets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'author'</span><span class="p">:</span> <span class="n">forms</span><span class="o">.</span><span class="n">HiddenInput</span><span class="p">(),</span>
        <span class="p">}</span>
</pre>
</div>
<p class="incremental">Reload again to see the input disappear. Check page source to see the 'hidden'
input.</p>
</div>
<div class="slide" id="form-submission">
<h1>Form Submission</h1>
<p>That's all we need to have for processing.  We want to:</p>
<ul class="incremental simple">
<li>Validate the form input</li>
<li>Report validation errors to the user and return the bound form</li>
<li>If no errors occur, save the form, creating an instance</li>
<li>Report success to the user and redirect to the list homepage.</li>
</ul>
<p class="incremental">Django's <tt class="docutils literal">messages</tt> framework will allow notifications.</p>
</div>
<div class="slide" id="handle-a-submitted-form">
<h1>Handle a Submitted Form</h1>
<p>In <tt class="docutils literal">views.py</tt>, update the <tt class="docutils literal">add_view</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PostForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;post '</span><span class="si">%s</span><span class="s">' saved&quot;</span> <span class="o">%</span> <span class="n">post</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">'blog_index'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                                 <span class="s">&quot;please fix the errors below&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">#...</span>
</pre>
</div>
<div class="slide" id="showing-messages">
<h1>Showing Messages</h1>
<p>The <tt class="docutils literal">messages</tt> framework pushes messages onto a stack.</p>
<p class="incremental">You can then pop them back off by printing them in a template.</p>
<div class="incremental container">
<p>In <tt class="docutils literal">base.html</tt> let's give them a place to go:</p>
<pre class="code jinja small literal-block">
<span class="x">&lt;div id=&quot;container&quot;&gt;
  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">messages</span> <span class="cp">%}</span><span class="x">
  &lt;div class=&quot;notifications&quot;&gt;
   </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">messages</span> <span class="cp">%}</span><span class="x">
   &lt;p&gt;</span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;
   </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
  &lt;/div&gt;
  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">
  &lt;!-- main content div below here --&gt;</span>
</pre>
</div>
</div>
<div class="slide" id="final-run">
<h1>Final Run</h1>
<p>That should be enough to get us going.</p>
<p class="incremental">Fill out your form, supplying title and text.</p>
<p class="incremental">Submit the form, and notice the messaging from the system.</p>
<p class="incremental">Why is your new post not appearing in the blog list?</p>
</div>
<div class="slide" id="next-steps">
<h1>Next Steps</h1>
<p>There are a number of improvements one could make to this blog system:</p>
<ul class="incremental simple">
<li>Send email notifications to &quot;blog administrators&quot; that would notify them of
new posts awaiting publication.</li>
<li>Provide a second list view giving users access to edit their unpublished
posts.</li>
<li>Provide restricted access to certain users to view all unpublished posts and
choose to publish them.</li>
<li>Add a form field for the post category and put the post in a category when
processing the form</li>
<li>Provide a list view of a category, showing all posts in it.</li>
<li>Provide HTML editing for post text.</li>
</ul>
</div>
<div class="slide" id="that-s-all-for-now">
<h1>That's All For Now</h1>
<p>But this is all we have time for in this session.</p>
<p class="big-centered incremental">We'll see you next session!</p>
</div>
</div>
</body>
</html>
