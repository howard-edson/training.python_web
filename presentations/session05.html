<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Python Web Programming</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Python Web Programming</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Python Web Programming</h1>

<img alt="img/bike.jpg" class="align-left" src="img/bike.jpg" style="width: 50%;" />
<p>Session 5: Frameworks and Flask</p>
<div class="intro-blurb right line-block">
<div class="line">&quot;Reinventing the wheel is great</div>
<div class="line">if your goal is to learn more about the wheel&quot;</div>
<div class="line"><br /></div>
<div class="line">-- James Tauber, PyCon 2007</div>
</div>
<p class="image-credit">image: Britanglishman <a class="reference external" href="http://www.flickr.com/photos/britanglishman/5999131365/">http://www.flickr.com/photos/britanglishman/5999131365/</a> - CC-BY</p>

</div>
<div class="slide" id="a-moment-to-reflect">
<h1>A Moment to Reflect</h1>
<p>We've been at this for a couple of days now.  We've learned a great deal:</p>
<ul class="incremental simple">
<li>Sockets, the TCP/IP Stack and Basic Mechanics</li>
<li>Web Protocols and the Importance of Clear Communication</li>
<li>APIs and Consuming Data from The Web</li>
<li>CGI and WSGI and Getting Information to Your Dynamic Applications</li>
</ul>
<p class="incremental">Everything we do from here out will be based on tools built using these
<em>foundational technologies</em>.</p>
</div>
<div class="slide" id="from-now-on">
<h1>From Now On</h1>
<p>Think of everything we do as sitting on top of WSGI</p>
<p class="incremental">This may not <em>actually</em> be true</p>
<p class="incremental">But we will always be working at that level of abstraction.</p>
</div>
<div class="slide" id="frameworks">
<h1>Frameworks</h1>
<p>From Wikipedia:</p>
<p class="center incremental">A web application framework (WAF) is a software framework that is designed to
support the development of dynamic websites, web applications and web
services. The framework aims to alleviate the overhead associated with common
activities performed in Web development. For example, many frameworks provide
libraries for database access, templating frameworks and session management,
and they often promote code reuse</p>
</div>
<div class="slide" id="what-does-that-mean">
<h1>What Does That <em>Mean</em>?</h1>
<p>You use a framework to build an application.</p>
<p class="incremental">A framework allows you to build different kinds of applications.</p>
<p class="incremental">A framework abstracts what needs to be abstracted, and allows control of the
rest.</p>
<p class="incremental">Think back over the last four sessions. What were your pain points? Which bits
do you wish you didn't have to think about?</p>
</div>
<div class="slide" id="level-of-abstraction">
<h1>Level of Abstraction</h1>
<p>This last part is important when it comes to choosing a framework</p>
<ul class="incremental simple">
<li>abstraction ‚àù 1/freedom</li>
<li>The more they choose, the less you can</li>
<li><em>Every</em> framework makes choices in what to abstract</li>
<li><em>Every</em> framework makes <em>different</em> choices</li>
</ul>
</div>
<div class="slide" id="python-web-frameworks">
<h1>Python Web Frameworks</h1>
<p>There are scores of 'em (this is a partial list).</p>
<table border="1" class="incremental invisible small center docutils">
<colgroup>
<col width="18%" />
<col width="16%" />
<col width="16%" />
<col width="20%" />
<col width="29%" />
</colgroup>
<tbody valign="top">
<tr><td>Django</td>
<td>Grok</td>
<td>Pylons</td>
<td>TurboGears</td>
<td>web2py</td>
</tr>
<tr><td>Zope</td>
<td>CubicWeb</td>
<td>Enamel</td>
<td>Gizmo(QP)</td>
<td>Glashammer</td>
</tr>
<tr><td>Karrigell</td>
<td>Nagare</td>
<td>notmm</td>
<td>Porcupine</td>
<td>QP</td>
</tr>
<tr><td>SkunkWeb</td>
<td>Spyce</td>
<td>Tipfy</td>
<td>Tornado</td>
<td>WebCore</td>
</tr>
<tr><td>web.py</td>
<td>Webware</td>
<td>Werkzeug</td>
<td>WHIFF</td>
<td>XPRESS</td>
</tr>
<tr><td>AppWsgi</td>
<td>Bobo</td>
<td>Bo7le</td>
<td>CherryPy</td>
<td>circuits.web</td>
</tr>
<tr><td>Paste</td>
<td>PyWebLib</td>
<td>WebStack</td>
<td>Albatross</td>
<td>Aquarium</td>
</tr>
<tr><td>Divmod</td>
<td>Nevow</td>
<td>Flask</td>
<td>JOTWeb2</td>
<td>Python Servlet</td>
</tr>
<tr><td>Engine</td>
<td>Pyramid</td>
<td>Quixote</td>
<td>Spiked</td>
<td>weblayer</td>
</tr>
</tbody>
</table>
</div>
<div class="slide" id="choosing-a-framework">
<h1>Choosing a Framework</h1>
<p>Many folks will tell you &quot;&lt;XYZ&gt; is the <strong>best</strong> framework&quot;.</p>
<p class="incremental">In most cases, what they really mean is &quot;I know how to use &lt;XYZ&gt;&quot;</p>
<p class="incremental">In some cases, what they really mean is &quot;&lt;XYZ&gt; fits my brain the best&quot;</p>
<p class="incremental">What they usually forget is that everyone's brain (and everyone's use-case) is
different.</p>
</div>
<div class="slide" id="cris-first-law-of-frameworks">
<h1>Cris' First Law of Frameworks</h1>
<p class="center"><strong>Pick the Right Tool for the Job</strong></p>
<p class="incremental">First Corollary</p>
<p class="incremental center">The right tool is the tool that allows you to finish the job quickly and
correctly.</p>
<p class="incremental center">But how do you know which that one is?</p>
</div>
<div class="slide" id="cris-second-law-of-frameworks">
<h1>Cris' Second Law of Frameworks</h1>
<p class="big-centered">You can't know unless you try</p>
<p class="incremental center">so let's try</p>
</div>
<div class="slide" id="practice-safe-development">
<h1>Practice Safe Development</h1>
<p>We are going to install Flask, and the packages it requires, into a
virtualenv.</p>
<p class="incremental">This will ensure that it is isolated from everything else we do in class (and
vice versa)</p>
<div class="incremental container">
<p>Remember the basic format for creating a virtualenv:</p>
<pre class="small literal-block">
$ python virtualenv.py [options] &lt;ENV&gt;
&lt;or&gt;
$ virtualenv [options] &lt;ENV&gt;
</pre>
</div>
</div>
<div class="slide" id="set-up-a-virtualenv">
<h1>Set Up a VirtualEnv</h1>
<p>Start by creating your virtualenv:</p>
<pre class="literal-block">
$ python virtualenv.py flaskenv
&lt;or&gt;
$ virtualenv flaskenv
...
</pre>
<div class="incremental container">
<p>Then, activate it:</p>
<pre class="literal-block">
$ source flaskenv/bin/activate
&lt;or&gt;
C:\&gt; flaskenv\Scripts\activate
</pre>
</div>
</div>
<div class="slide" id="install-flask">
<h1>Install Flask</h1>
<p>Finally, install Flask using <cite>setuptools</cite> or <cite>pip</cite>:</p>
<pre class="literal-block">
(flaskenv)$ pip install flask
Downloading/unpacking flask
  Downloading Flask-0.10.1.tar.gz (544kB): 544kB downloaded
...
Installing collected packages: flask, Werkzeug, Jinja2,
  itsdangerous, markupsafe
...
Successfully installed flask Werkzeug Jinja2 itsdangerous
  markupsafe
</pre>
</div>
<div class="slide" id="kicking-the-tires">
<h1>Kicking the Tires</h1>
<p>We've installed the Flask microframework and all of its dependencies.</p>
<p class="incremental">Now, let's see what it can do</p>
<p class="incremental">In your class working directory, create a file called <tt class="docutils literal">flask_intro.py</tt> and
open it in your text editor.</p>
</div>
<div class="slide" id="flask">
<h1>Flask</h1>
<p>Getting started with Flask is pretty straightforward. Here's a complete,
simple app.  Type it into <cite>flask_intro.py</cite>:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'Hello World!'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre>
</div>
<div class="slide" id="running-our-app">
<h1>Running our App</h1>
<p>As you might expect by now, the last block in our <tt class="docutils literal">flask_intro.py</tt> file
allows us to run this as a python program. Save your file, and in your
terminal try this:</p>
<pre class="literal-block">
(flaskenv)$ python flask_intro.py
</pre>
<p class="incremental">Load <tt class="docutils literal"><span class="pre">http://localhost:5000</span></tt> in your browser to see it in action.</p>
</div>
<div class="slide" id="debugging-our-app">
<h1>Debugging our App</h1>
<p>Last week, <tt class="docutils literal">cgitb</tt> provided us with useful feedback when building an app.
Flask has similar functionality. Make the following changes to your
<tt class="docutils literal">flask_intro.py</tt> file:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="s">'Hello World!'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre>
<p class="incremental">Restart your app and then reload your browser to see what happens (clean up
the error when you're done).</p>
</div>
<div class="slide" id="what-s-happening-here">
<h1>What's Happening Here?</h1>
<p>Flask the framework provides a Python class called <cite>Flask</cite>. This class
functions as a single <em>application</em> in the WSGI sense.</p>
<p class="incremental">Remember, a WSGI application must be a <em>callable</em> that takes the arguments
<em>environ</em> and <em>start_response</em>.</p>
<p class="incremental">It has to call the <em>start_response</em> method, providing status and headers.</p>
<p class="incremental">And it has to return an <em>iterable</em> that represents the HTTP response body.</p>
</div>
<div class="slide" id="under-the-covers">
<h1>Under the Covers</h1>
<p>In Python, an object is a <em>callable</em> if it has a <tt class="docutils literal">__call__</tt> method.</p>
<div class="incremental container">
<p>Here's the <tt class="docutils literal">__call__</tt> method of the <tt class="docutils literal">Flask</tt> class:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shortcut for :attr:`wsgi_app`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre>
</div>
<p class="incremental">As you can see, it calls another method, called <tt class="docutils literal">wsgi_app</tt>.  Let's follow
this down...</p>
</div>
<div class="slide" id="flask-wsgi-app">
<h1>Flask.wsgi_app</h1>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The actual WSGI application.
    ...
    &quot;&quot;&quot;</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
    <span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dispatch_request</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    <span class="c">#...</span>
</pre>
<p class="incremental"><tt class="docutils literal">response</tt> is another WSGI app.  <tt class="docutils literal">Flask</tt> is actually <em>middleware</em></p>
</div>
<div class="slide" id="abstraction-layers">
<h1>Abstraction Layers</h1>
<p>Finally, way down in a package called <em>werkzeug</em>, we find this response object
and it's <tt class="docutils literal">__call__</tt> method:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process this response as WSGI application.

    :param environ: the WSGI environment.
    :param start_response: the response callable provided by the WSGI
                           server.
    :return: an application iterator
    &quot;&quot;&quot;</span>
    <span class="n">app_iter</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wsgi_response</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app_iter</span>
</pre>
</div>
<div class="slide" id="common-threads">
<h1>Common Threads</h1>
<p>All Python web frameworks that operate under the WSGI spec will do this same
sort of thing.</p>
<p class="incremental">They have to do it.</p>
<p class="incremental">And these layers of abstraction allow you, the developer to focus only on the
thing that really matters to you.</p>
<p class="incremental">Getting input from a request, and returning a response.</p>
</div>
<div class="slide" id="popping-back-up-the-stack">
<h1>Popping Back Up the Stack</h1>
<p>Returning up to the level where we will be working, remember what you've done:</p>
<ul class="incremental simple">
<li>You instantiated a <cite>Flask</cite> app with a name that represents the package or
module containing the app<ul>
<li>Because our app is a single Python module, this should be <tt class="docutils literal">__name__</tt></li>
<li>This is used to help the <cite>Flask</cite> app figure out where to look for
<em>resources</em></li>
</ul>
</li>
<li>You defined a function that returned a response body</li>
<li>You told the app which requests should use that function with a <em>route</em></li>
</ul>
<p class="incremental">Let's take a look at how that last bit works for a moment...</p>
</div>
<div class="slide" id="url-routing">
<h1>URL Routing</h1>
<p>Remember our bookdb exercise? How did you end up solving the problem of
mapping an HTTP request to the right function?</p>
<p class="incremental">Flask solves this problem by using the <cite>route</cite> decorator from your app.</p>
<p class="incremental">A 'route' takes a URL rule (more on that in a minute) and maps it to an
<em>endpoint</em> and a <em>function</em>.</p>
<p class="incremental">When a request arrives at a URL that matches a known rule, the function is
called.</p>
</div>
<div class="slide" id="url-rules">
<h1>URL Rules</h1>
<p>URL Rules are strings that represent what environ['PATH_INFO'] will look like.</p>
<p class="incremental">They are added to a <em>mapping</em> on the Flask object called the <em>url_map</em></p>
<p class="incremental">You can call <tt class="docutils literal">app.add_url_rule()</tt> to add a new one</p>
<p class="incremental">Or you can use what we've used, the <tt class="docutils literal">app.route()</tt> decorator</p>
</div>
<div class="slide" id="function-or-decorator">
<h1>Function or Decorator</h1>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;some function that returns something&quot;&quot;&quot;</span>
    <span class="c"># ...</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="s">'homepage'</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</pre>
<div class="incremental container">
<p>is identical to</p>
<pre class="code python small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="s">'homepage'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;some function that returns something&quot;&quot;&quot;</span>
    <span class="c"># ...</span>
</pre>
</div>
</div>
<div class="slide" id="routes-can-be-dynamic">
<h1>Routes Can Be Dynamic</h1>
<p>A <em>placeholder</em> in a URL rule becomes a named arg to your function (add these
to <tt class="docutils literal">flask_intro.py</tt>):</p>
<pre class="code python incremental small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/profile/&lt;username&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_profile</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;My username is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">username</span>
</pre>
<p class="incremental">And <em>converters</em> ensure the incoming argument is of the correct type.</p>
<pre class="code python incremental small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/div/&lt;float:val&gt;/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">divide</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%0.2f</span><span class="s"> divided by 2 is </span><span class="si">%0.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="routes-can-be-filtered">
<h1>Routes Can Be Filtered</h1>
<p>You can also determine which HTTP <em>methods</em> a given route will accept:</p>
<pre class="code python small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/blog/entry/&lt;int:id&gt;/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,])</span>
<span class="k">def</span> <span class="nf">read_entry</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;reading entry </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">id</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/blog/entry/&lt;int:id&gt;/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="p">])</span>
<span class="k">def</span> <span class="nf">write_entry</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'writing entry </span><span class="si">%d</span><span class="s">'</span> <span class="o">%</span> <span class="nb">id</span>
</pre>
<p class="incremental">After adding that to <tt class="docutils literal">flask_intro.py</tt> and saving, try loading
<tt class="docutils literal"><span class="pre">http://localhost:5000/blog/entry/23/</span></tt> into your browser. Which was called?</p>
</div>
<div class="slide" id="routes-can-be-reversed">
<h1>Routes Can Be Reversed</h1>
<p>Reversing a URL means the ability to generate the url that would result in a
given endpoint being called.</p>
<p class="incremental">This means <em>you don't have to hard-code your URLs when building links</em></p>
<p class="incremental">That means <em>you can change the URLs for your app without changing code or
templates</em></p>
<p class="incremental">This is called <strong>decoupling</strong> and it is a good thing</p>
</div>
<div class="slide" id="reversing-urls-in-flask">
<h1>Reversing URLs in Flask</h1>
<p>In Flask, you reverse a url with the <tt class="docutils literal">url_for</tt> function.</p>
<ul class="incremental simple">
<li><tt class="docutils literal">url_for</tt> requires an HTTP request context to work</li>
<li>You can fake an HTTP request when working in a terminal (or testing)</li>
<li>Use the <tt class="docutils literal">test_request_context</tt> method of your app object</li>
<li>This is a great chance to use the Python <tt class="docutils literal">with</tt> statement</li>
<li><strong>Don't type this</strong></li>
</ul>
<pre class="code python small incremental literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
  <span class="k">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'endpoint'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="reversing-in-action">
<h1>Reversing in Action</h1>
<p>Quit your Flask app with <tt class="docutils literal">^C</tt>.  Then start a python interpreter in that same
terminal and import your <tt class="docutils literal">flask_intro.py</tt> module:</p>
<pre class="code python literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">flask_intro</span> <span class="kn">import</span> <span class="n">app</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
<span class="o">...</span>     <span class="k">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'show_profile'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&quot;cris&quot;</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'divide'</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">23.7</span><span class="p">)</span>
<span class="o">...</span>
<span class="s">'/profile/cris/'</span>
<span class="s">'/div/23.7/'</span>
<span class="o">&gt;&gt;&gt;</span>
</pre>
</div>
<div class="slide" id="break-time">
<h1>Break Time</h1>
<p>Now's a good time to take a rest.</p>
<p class="incremental">When we return, we'll take a look at templating and data persistence.</p>
</div>
<div class="slide" id="generating-html">
<h1>Generating HTML</h1>
<p class="big-centered">&quot;I enjoy writing HTML in Python&quot;</p>
<p class="incremental right">-- nobody, ever</p>
</div>
<div class="slide" id="templating">
<h1>Templating</h1>
<p>A good framework will provide some way of generating HTML with a templating
system.</p>
<p class="incremental">There are nearly as many templating systems as there are frameworks</p>
<p class="incremental">Each has advantages and disadvantages</p>
<p class="incremental">Flask includes the <em>Jinja2</em> templating system (perhaps because it's built by
the same folks)</p>
</div>
<div class="slide" id="jinja2-template-basics">
<h1>Jinja2 Template Basics</h1>
<p>Let's start with the absolute basics.</p>
<div class="incremental container">
<p>Fire up a Python interpreter, using your flask virtualenv:</p>
<pre class="code python small literal-block">
<span class="p">(</span><span class="n">flaskenv</span><span class="p">)</span><span class="err">$</span> <span class="n">python</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
</pre>
</div>
<div class="incremental container">
<p>A template is built of a simple string:</p>
<pre class="code python small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&quot;Hello {{ name }}, how are you?&quot;</span><span class="p">)</span>
</pre>
</div>
</div>
<div class="slide" id="rendering-a-template">
<h1>Rendering a Template</h1>
<p>Call the <tt class="docutils literal">render</tt> method, providing some <em>context</em>:</p>
<pre class="code python incremental small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Freddy&quot;</span><span class="p">)</span>
<span class="s">u'Hello Freddy, how are you?'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">render</span><span class="p">({</span><span class="s">'name'</span><span class="p">:</span> <span class="s">&quot;Roberto&quot;</span><span class="p">})</span>
<span class="s">u'Hello Roberto, how are you?'</span>
<span class="o">&gt;&gt;&gt;</span>
</pre>
<p class="incremental"><em>Context</em> can either be keyword arguments, or a dictionary</p>
</div>
<div class="slide" id="dictionaries-in-context">
<h1>Dictionaries in Context</h1>
<p>Dictionaries passed in as part of the <em>context</em> can be addressed with <em>either</em>
subscript or dotted notation:</p>
<pre class="code python incremental small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">person</span> <span class="o">=</span> <span class="p">{</span><span class="s">'first_name'</span><span class="p">:</span> <span class="s">'Frank'</span><span class="p">,</span>
<span class="o">...</span>           <span class="s">'last_name'</span><span class="p">:</span> <span class="s">'Herbert'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&quot;{{ person.last_name }}, {{ person['first_name'] }}&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t2</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="n">person</span><span class="p">)</span>
<span class="s">u'Herbert, Frank'</span>
</pre>
<ul class="incremental simple">
<li>Jinja2 will try the <em>correct</em> way first (attr for dotted, item for
subscript).</li>
<li>If nothing is found, it will try the opposite.</li>
<li>If nothing is found, it will return an <em>undefined</em> object.</li>
</ul>
</div>
<div class="slide" id="objects-in-context">
<h1>Objects in Context</h1>
<p>The exact same is true of objects passed in as part of <em>context</em>:</p>
<pre class="code python incremental small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">t3</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&quot;{{ obj.x }} + {{ obj['y'] }} = Fun!&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Game</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="o">...</span>   <span class="n">x</span> <span class="o">=</span> <span class="s">'babies'</span>
<span class="o">...</span>   <span class="n">y</span> <span class="o">=</span> <span class="s">'bubbles'</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bathtime</span> <span class="o">=</span> <span class="n">Game</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t3</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">bathtime</span><span class="p">)</span>
<span class="s">u'babies + bubbles = Fun!'</span>
</pre>
<p class="incremental">This means your templates can be a bit agnostic as to the nature of the things
in <em>context</em></p>
</div>
<div class="slide" id="filtering-values-in-templates">
<h1>Filtering values in Templates</h1>
<p>You can apply <em>filters</em> to the data passed in <em>context</em> with the pipe ('|')
operator:</p>
<pre class="code python incremental small literal-block">
<span class="n">t4</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&quot;shouted: {{ phrase|upper }}&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t4</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">phrase</span><span class="o">=</span><span class="s">&quot;this is very important&quot;</span><span class="p">)</span>
<span class="s">u'shouted: THIS IS VERY IMPORTANT'</span>
</pre>
<div class="incremental container">
<p>You can also chain filters together:</p>
<pre class="code python small literal-block">
<span class="n">t5</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&quot;confusing: {{ phrase|upper|reverse }}&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t5</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">phrase</span><span class="o">=</span><span class="s">&quot;howdy doody&quot;</span><span class="p">)</span>
<span class="s">u'confusing: YDOOD YDWOH'</span>
</pre>
</div>
</div>
<div class="slide" id="control-flow">
<h1>Control Flow</h1>
<p>Logical control structures are also available:</p>
<pre class="code python incremental small literal-block">
<span class="n">tmpl</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;
... {</span><span class="si">% f</span><span class="s">or item in list %}{{ item }}, {</span><span class="si">% e</span><span class="s">ndfor %}
... &quot;&quot;&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t6</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">tmpl</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t6</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>
<span class="s">u'</span><span class="se">\n</span><span class="s">1, 2, 3, 4, 5, 6, '</span>
</pre>
<p class="incremental">Any control structure introduced in a template <strong>must</strong> be paired with an
explicit closing tag ({% for %}...{% endfor %})</p>
</div>
<div class="slide" id="template-tests">
<h1>Template Tests</h1>
<p>There are a number of specialized <em>tests</em> available for use with the
<tt class="docutils literal"><span class="pre">if...elif...else</span></tt> control structure:</p>
<pre class="code python incremental small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">tmpl</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;
... {</span><span class="si">% i</span><span class="s">f phrase is upper %}
...   {{ phrase|lower }}
... {</span><span class="si">% e</span><span class="s">lif phrase is lower %}
...   {{ phrase|upper }}
... {</span><span class="si">% e</span><span class="s">lse %}{{ phrase }}{</span><span class="si">% e</span><span class="s">ndif %}&quot;&quot;&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t7</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">tmpl</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t7</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">phrase</span><span class="o">=</span><span class="s">&quot;FOO&quot;</span><span class="p">)</span>
<span class="s">u'</span><span class="se">\n\n</span><span class="s">  foo</span><span class="se">\n</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t7</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">phrase</span><span class="o">=</span><span class="s">&quot;bar&quot;</span><span class="p">)</span>
<span class="s">u'</span><span class="se">\n\n</span><span class="s">  BAR</span><span class="se">\n</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t7</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">phrase</span><span class="o">=</span><span class="s">&quot;This should print as-is&quot;</span><span class="p">)</span>
<span class="s">u'</span><span class="se">\n</span><span class="s">This should print as-is'</span>
</pre>
</div>
<div class="slide" id="basic-python-expressions">
<h1>Basic Python Expressions</h1>
<p>Basic Python expressions are also supported:</p>
<pre class="code python incremental small literal-block">
<span class="n">tmpl</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;
... {</span><span class="si">% s</span><span class="s">et sum = 0 %}
... {</span><span class="si">% f</span><span class="s">or val in values %}
... {{ val }}: {{ sum + val }}
...   {</span><span class="si">% s</span><span class="s">et sum = sum + val %}
... {</span><span class="si">% e</span><span class="s">ndfor %}
... &quot;&quot;&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t8</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">tmpl</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t8</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">))</span>
<span class="s">u'</span><span class="se">\n\n\n</span><span class="s">1: 1</span><span class="se">\n</span><span class="s">  </span><span class="se">\n\n</span><span class="s">2: 3</span><span class="se">\n</span><span class="s">  </span><span class="se">\n\n</span><span class="s">3: 6</span><span class="se">\n</span><span class="s">  </span><span class="se">\n\n</span><span class="s">4: 10</span><span class="se">\n</span>
  \<span class="n">n</span>\<span class="n">n5</span><span class="p">:</span> <span class="mi">15</span>\<span class="n">n</span>  \<span class="n">n</span>\<span class="n">n6</span><span class="p">:</span> <span class="mi">21</span>\<span class="n">n</span>  \<span class="n">n</span>\<span class="n">n7</span><span class="p">:</span> <span class="mi">28</span>\<span class="n">n</span>  \<span class="n">n</span>\<span class="n">n8</span><span class="p">:</span> <span class="mi">36</span>\<span class="n">n</span>
  \<span class="n">n</span>\<span class="n">n9</span><span class="p">:</span> <span class="mi">45</span>\<span class="n">n</span>  \<span class="n">n</span>\<span class="n">n10</span><span class="p">:</span> <span class="mi">55</span>\<span class="n">n</span>  \<span class="n">n</span><span class="s">'</span>
</pre>
</div>
<div class="slide" id="much-much-more">
<h1>Much, Much More</h1>
<p>There's more that Jinja2 templates can do, and we'll see more in the next
session when we write templates for our Flask app.</p>
<div class="incremental container">
<p>Make sure that you bookmark the Jinja2 documentation for later use:</p>
<pre class="literal-block">
http://jinja.pocoo.org/docs/templates/
</pre>
</div>
</div>
<div class="slide" id="data-persistence">
<h1>Data Persistence</h1>
<p>There are many models for persistance of data.</p>
<ul class="incremental simple">
<li>Flat files</li>
<li>Relational Database (SQL RDBMs like PostgreSQL, MySQL, SQLServer, Oracle)</li>
<li>Object Stores (Pickle, ZODB)</li>
<li>NoSQL Databases (CouchDB, MongoDB, etc)</li>
</ul>
<p class="incremental">It's also one of the most contentious issues in app design.</p>
<p class="incremental">For this reason, it's one of the things that most Small Frameworks leave
undecided, Flask included.</p>
</div>
<div class="slide" id="simple-sql">
<h1>Simple SQL</h1>
<p><a class="reference external" href="http://www.python.org/dev/peps/pep-0249/">PEP 249</a> describes a
common API for database connections called DB-API 2.</p>
<div class="incremental container">
<p>The goal was to</p>
<blockquote>
<p>achieve a consistency leading to more easily understood modules, code
that is generally more portable across databases, and a broader reach
of database connectivity from Python</p>
<p class="image-credit">source: <a class="reference external" href="http://www.python.org/dev/peps/pep-0248/">http://www.python.org/dev/peps/pep-0248/</a></p>
</blockquote>
</div>
</div>
<div class="slide" id="a-note-on-db-api">
<h1>A Note on DB API</h1>
<p class="incremental center">It is important to remember that PEP 249 is <strong>only a specification</strong>.</p>
<p class="incremental">There is no code or package for DB-API 2 on it's own.</p>
<p class="incremental">Since 2.5, the Python Standard Library has provided a <a class="reference external" href="http://docs.python.org/2/library/sqlite3.html">reference
implementation of the api</a>
based on SQLite3</p>
<p class="incremental">Before Python 2.5, this package was available as <tt class="docutils literal">pysqlite</tt></p>
</div>
<div class="slide" id="using-db-api">
<h1>Using DB API</h1>
<p>To use the DB API with any database other than SQLite3, you must have an
underlying API package available.</p>
<div class="incremental container">
<p>Implementations are available for:</p>
<ul class="simple">
<li>PostgreSQL (<strong>psycopg2</strong>, txpostgres, ...)</li>
<li>MySQL (<strong>mysql-python</strong>, PyMySQL, ...)</li>
<li>MS SQL Server (<strong>adodbapi</strong>, pymssql, mxODBC, pyodbc, ...)</li>
<li>Oracle (<strong>cx_Oracle</strong>, mxODBC, pyodbc, ...)</li>
<li>and many more...</li>
</ul>
<p class="image-credit">source: <a class="reference external" href="http://wiki.python.org/moin/DatabaseInterfaces">http://wiki.python.org/moin/DatabaseInterfaces</a></p>
</div>
</div>
<div class="slide" id="installing-api-packages">
<h1>Installing API Packages</h1>
<p>Most db api packages can be installed using typical Pythonic methods:</p>
<pre class="literal-block">
$ easy_install psycopg2
$ pip install mysql-python
...
</pre>
<p class="incremental">Most api packages will require that the development headers for the underlying
database system be available. Without these, the C symbols required for
communication with the db are not present and the wrapper cannot work.</p>
</div>
<div class="slide" id="not-today">
<h1>Not Today</h1>
<p>We don't want to spend the next hour getting a package installed, so let's use
<tt class="docutils literal">sqlite3</tt> instead.</p>
<p class="incremental">I <strong>do not</strong> recommend using sqlite3 for production web applications, there are
too many ways in which it falls short</p>
<p class="incremental">But it will provide a solid learning tool</p>
</div>
<div class="slide" id="getting-started">
<h1>Getting Started</h1>
<p>In the class resources folder, you'll find an <tt class="docutils literal">sql</tt> directory. Copy that to
your working directory.</p>
<p class="incremental">Open the file <tt class="docutils literal">createdb.py</tt> in your text editor.  Edit <tt class="docutils literal">main</tt> like so:</p>
<pre class="code python incremental small literal-block">
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span>  <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_FILENAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DB_IS_NEW</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">'Need to create database and schema'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">'Database exists, assume schema does, too.'</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
</div>
<div class="slide" id="try-it-out">
<h1>Try It Out</h1>
<p>Run the <tt class="docutils literal">createdb.py</tt> script to see it in effect:</p>
<pre class="literal-block">
$ python createdb.py
Need to create database and schema
$ python createdb.py
Database exists, assume schema does, too.
$ ls
books.db
...
</pre>
<p class="incremental">Sqlite3 will automatically create a new database when you connect for the
first time, if one does not exist.</p>
</div>
<div class="slide" id="set-up-a-schema">
<h1>Set Up A Schema</h1>
<p>Make the following changes to <tt class="docutils literal">createdb.py</tt>:</p>
<pre class="code python small literal-block">
<span class="n">DB_FILENAME</span> <span class="o">=</span> <span class="s">'books.db'</span>
<span class="n">SCHEMA_FILENAME</span> <span class="o">=</span> <span class="s">'ddl.sql'</span> <span class="c"># &lt;- this is new</span>
<span class="n">DB_IS_NEW</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DB_FILENAME</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_FILENAME</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span> <span class="c"># &lt;- context mgr</span>
        <span class="k">if</span> <span class="n">DB_IS_NEW</span><span class="p">:</span> <span class="c"># A whole new if clause:</span>
            <span class="k">print</span> <span class="s">'Creating schema'</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SCHEMA_FILENAME</span><span class="p">,</span> <span class="s">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">'Database exists, assume schema does, too.'</span>
    <span class="c"># delete the `conn.close()` that was here.</span>
</pre>
</div>
<div class="slide" id="verify-your-work">
<h1>Verify Your Work</h1>
<p>Quit your python interpreter and delete the file <tt class="docutils literal">books.db</tt></p>
<div class="incremental container">
<p>Then run the script from the command line again to try it out:</p>
<pre class="literal-block">
$ python createdb.py
Creating schema
$ python createdb.py
Database exists, assume schema does, too.
</pre>
</div>
</div>
<div class="slide" id="introspect-the-database">
<h1>Introspect the Database</h1>
<p>Add the following to <tt class="docutils literal">createdb.py</tt>:</p>
<pre class="code python small literal-block">
<span class="c"># in the imports, add this line:</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">show_table_metadata</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c"># in the else clause, replace the print statement with this:</span>
    <span class="k">print</span> <span class="s">&quot;Database exists, introspecting:&quot;</span>
    <span class="n">tablenames</span> <span class="o">=</span> <span class="p">[</span><span class="s">'author'</span><span class="p">,</span> <span class="s">'book'</span><span class="p">]</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tablenames</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">show_table_metadata</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre>
<p class="incremental">Then try running <tt class="docutils literal">python createdb.py</tt> again</p>
</div>
<div class="slide" id="my-results">
<h1>My Results</h1>
<pre class="small literal-block">
$ python createdb.py
Table Metadata for 'author':
cid        | name       | type       | notnull    | dflt_value | pk         |
-----------+------------+------------+------------+------------+------------+-
0          | authorid   | INTEGER    | 1          | None       | 1          |
-----------+------------+------------+------------+------------+------------+-
1          | name       | TEXT       | 0          | None       | 0          |
-----------+------------+------------+------------+------------+------------+-


Table Metadata for 'book':
cid        | name       | type       | notnull    | dflt_value | pk         |
-----------+------------+------------+------------+------------+------------+-
0          | bookid     | INTEGER    | 1          | None       | 1          |
-----------+------------+------------+------------+------------+------------+-
1          | title      | TEXT       | 0          | None       | 0          |
-----------+------------+------------+------------+------------+------------+-
2          | author     | INTEGER    | 1          | None       | 0          |
-----------+------------+------------+------------+------------+------------+-
</pre>
</div>
<div class="slide" id="inserting-data">
<h1>Inserting Data</h1>
<p>Let's load up some data. Fire up your interpreter and type:</p>
<pre class="code python small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">insert</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;
... INSERT INTO author (name) VALUES(&quot;Iain M. Banks&quot;);&quot;&quot;&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;books.db&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>
<span class="o">...</span>     <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Cursor</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10046e880</span><span class="o">&gt;</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span>
</pre>
<p class="incremental">Did that work?</p>
</div>
<div class="slide" id="querying-data">
<h1>Querying Data</h1>
<p>Let's query our database to find out:</p>
<pre class="code python small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;
... SELECT * from author;&quot;&quot;&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;books.db&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">print</span> <span class="n">row</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Cursor</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10046e8f0</span><span class="o">&gt;</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">u'Iain M. Banks'</span><span class="p">)</span>
</pre>
<p class="incremental">Alright!  We've got data in there.  Let's make it more efficient</p>
</div>
<div class="slide" id="parameterized-statements">
<h1>Parameterized Statements</h1>
<p>Try this:</p>
<pre class="code python small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">insert</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;
... INSERT INTO author (name) VALUES(?);&quot;&quot;&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">authors</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&quot;China Mieville&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;Frank Herbert&quot;</span><span class="p">],</span>
<span class="o">...</span> <span class="p">[</span><span class="s">&quot;J.R.R. Tolkien&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;Susan Cooper&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;Madeline L'Engle&quot;</span><span class="p">]]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;books.db&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">insert</span><span class="p">,</span> <span class="n">authors</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">print</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>
<span class="o">...</span>     <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Cursor</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10046e8f0</span><span class="o">&gt;</span>
<span class="mi">5</span>
</pre>
</div>
<div class="slide" id="check-your-work">
<h1>Check Your Work</h1>
<p>Again, query the database:</p>
<pre class="code python small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;
... SELECT * from author;&quot;&quot;&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;books.db&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">print</span> <span class="n">row</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Cursor</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10046e8f0</span><span class="o">&gt;</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">u'Iain M. Banks'</span><span class="p">)</span>
<span class="o">...</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">u'J.R.R. Tolkien'</span><span class="p">)</span>
<span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">u'Susan Cooper'</span><span class="p">)</span>
<span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">u&quot;Madeline L'Engle&quot;</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="transactions">
<h1>Transactions</h1>
<p>Transactions group operations together, allowing you to verify them <em>before</em>
the results hit the database.</p>
<p class="incremental">In SQLite3, data-altering statements require an explicit <tt class="docutils literal">commit</tt> unless
auto-commit has been enabled.</p>
<p class="incremental">The <tt class="docutils literal">with</tt> statements we've used take care of committing when the context
manager closes.</p>
<p class="incremental">Let's change that so we can see what happens explicitly</p>
</div>
<div class="slide" id="populating-the-database">
<h1>Populating the Database</h1>
<p>Let's start by seeing what happens when you try to look for newly added data
before the <tt class="docutils literal">insert</tt> transaction is committed.</p>
<p class="incremental">Begin by quitting your interpreter and deleting <tt class="docutils literal">books.db</tt>.</p>
<div class="incremental container">
<p>Then re-create the database, empty:</p>
<pre class="literal-block">
$ python createdb.py
Creating schema
</pre>
</div>
</div>
<div class="slide" id="setting-up-the-test">
<h1>Setting Up the Test</h1>
<p class="small">Open <tt class="docutils literal">populatedb.py</tt> in your editor, replace the final <tt class="docutils literal">print</tt>:</p>
<pre class="code python small literal-block">
<span class="n">conn1</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_FILENAME</span><span class="p">)</span>
<span class="n">conn2</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_FILENAME</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">On conn1, before insert:&quot;</span>
<span class="n">show_authors</span><span class="p">(</span><span class="n">conn1</span><span class="p">)</span>
<span class="n">authors</span> <span class="o">=</span> <span class="p">([</span><span class="n">author</span><span class="p">]</span> <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">AUTHORS_BOOKS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn1</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">author_insert</span><span class="p">,</span> <span class="n">authors</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">On conn1, after insert:&quot;</span>
<span class="n">show_authors</span><span class="p">(</span><span class="n">conn1</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">On conn2, before commit:&quot;</span>
<span class="n">show_authors</span><span class="p">(</span><span class="n">conn2</span><span class="p">)</span>
<span class="n">conn1</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">On conn2, after commit:&quot;</span>
<span class="n">show_authors</span><span class="p">(</span><span class="n">conn2</span><span class="p">)</span>
<span class="n">conn1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">conn2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
</div>
<div class="slide" id="running-the-test">
<h1>Running the Test</h1>
<p class="small">Quit your python interpreter and run the <tt class="docutils literal">populatedb.py</tt> script:</p>
<pre class="small incremental literal-block">
On conn1, before insert:
no rows returned
On conn1, after insert:
(1, u'China Mieville')
(2, u'Frank Herbert')
(3, u'Susan Cooper')
(4, u'J.R.R. Tolkien')
(5, u&quot;Madeline L'Engle&quot;)

On conn2, before commit:
no rows returned
On conn2, after commit:
(1, u'China Mieville')
(2, u'Frank Herbert')
(3, u'Susan Cooper')
(4, u'J.R.R. Tolkien')
(5, u&quot;Madeline L'Engle&quot;)
</pre>
</div>
<div class="slide" id="rollback">
<h1>Rollback</h1>
<p>That's all well and good, but what happens if an error occurs?</p>
<p class="incremental">Transactions can be rolled back in order to wipe out partially completed work.</p>
<p class="incremental">Like with commit, using <tt class="docutils literal">connect</tt> as a context manager in a <tt class="docutils literal">with</tt>
statement will automatically rollback for exceptions.</p>
<p class="incremental">Let's rewrite our populatedb script so it explicitly commits or rolls back a
transaction depending on exceptions occurring</p>
</div>
<div class="slide" id="edit-populatedb-py-slide-1">
<h1>Edit populatedb.py (slide 1)</h1>
<p class="small">First, add the following function above the <tt class="docutils literal">if __name__ == '__main__'</tt>
block:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">populate_db</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="n">authors</span> <span class="o">=</span> <span class="p">([</span><span class="n">author</span><span class="p">]</span> <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">AUTHORS_BOOKS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">author_insert</span><span class="p">,</span> <span class="n">authors</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">AUTHORS_BOOKS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">([</span><span class="n">book</span><span class="p">,</span> <span class="n">author</span><span class="p">]</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">AUTHORS_BOOKS</span><span class="p">[</span><span class="n">author</span><span class="p">])</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">book_insert</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="edit-populatedb-py-slide-2">
<h1>Edit populatedb.py (slide 2)</h1>
<p class="small">Then, in the runner:</p>
<pre class="code python small literal-block">
<span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_FILENAME</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn1</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_FILENAME</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn2</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">populate_db</span><span class="p">(</span><span class="n">conn1</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">authors and books on conn2 before commit:&quot;</span>
            <span class="n">show_authors</span><span class="p">(</span><span class="n">conn2</span><span class="p">)</span>
            <span class="n">show_books</span><span class="p">(</span><span class="n">conn2</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="n">conn1</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">authors and books on conn2 after rollback:&quot;</span>
            <span class="n">show_authors</span><span class="p">(</span><span class="n">conn2</span><span class="p">)</span>
            <span class="n">show_books</span><span class="p">(</span><span class="n">conn2</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn1</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">authors and books on conn2 after commit:&quot;</span>
            <span class="n">show_authors</span><span class="p">(</span><span class="n">conn2</span><span class="p">)</span>
            <span class="n">show_books</span><span class="p">(</span><span class="n">conn2</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id1">
<h1>Try it Out</h1>
<p>Remove <tt class="docutils literal">books.db</tt> and recrete the database, then run our script:</p>
<pre class="small literal-block">
$ rm books.db
$ python createdb.py
Creating schema
$ python populatedb.py
</pre>
<pre class="small incremental literal-block">
authors and books on conn2 after rollback:
no rows returned
no rows returned
Traceback (most recent call last):
  File &quot;populatedb.py&quot;, line 57, in &lt;module&gt;
    populate_db(conn1)
  File &quot;populatedb.py&quot;, line 46, in populate_db
    cur.executemany(book_insert, params)
sqlite3.InterfaceError: Error binding parameter 0 - probably unsupported type.
</pre>
</div>
<div class="slide" id="oooops-fix-it">
<h1>Oooops, Fix It</h1>
<p class="small">Okay, we got an error, and the transaction was rolled back correctly.</p>
<div class="incremental small container">
<p>Open <tt class="docutils literal">utils.py</tt> and find this:</p>
<pre class="code python literal-block">
<span class="s">'Susan Cooper'</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;The Dark is Rising&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;The Greenwitch&quot;</span><span class="p">]],</span>
</pre>
</div>
<div class="incremental small container">
<p>Fix it like so:</p>
<pre class="code python literal-block">
<span class="s">'Susan Cooper'</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;The Dark is Rising&quot;</span><span class="p">,</span> <span class="s">&quot;The Greenwitch&quot;</span><span class="p">],</span>
</pre>
</div>
<p class="small incremental">It appears that we were attempting to bind a list as a parameter.  Ooops.</p>
</div>
<div class="slide" id="try-it-again">
<h1>Try It Again</h1>
<div class="small container">
<p>Now that the error in our data is repaired, let's try again:</p>
<pre class="literal-block">
$ python populatedb.py
</pre>
</div>
<pre class="small incremental literal-block">
Reporting authors and books on conn2 before commit:
no rows returned
no rows returned
Reporting authors and books on conn2 after commit:
(1, u'China Mieville')
(2, u'Frank Herbert')
(3, u'Susan Cooper')
(4, u'J.R.R. Tolkien')
(5, u&quot;Madeline L'Engle&quot;)
(1, u'Perdido Street Station', 1)
(2, u'The Scar', 1)
(3, u'King Rat', 1)
(4, u'Dune', 2)
(5, u&quot;Hellstrom's Hive&quot;, 2)
(6, u'The Dark is Rising', 3)
(7, u'The Greenwitch', 3)
(8, u'The Hobbit', 4)
(9, u'The Silmarillion', 4)
(10, u'A Wrinkle in Time', 5)
(11, u'A Swiftly Tilting Planet', 5)
</pre>
</div>
<div class="slide" id="next-steps">
<h1>Next Steps</h1>
<p>We've learned a bit about the basics of using Flask, writing templates and
using DB API to persist data.</p>
<p class="incremental">This afternoon, we'll put this to use by writing a small application in Flask</p>
<p class="incremental">By the end of the day, we'll have a fully-tested microblog ready to go.</p>
</div>
<div class="slide" id="lunch-time">
<h1>Lunch Time</h1>
<p class="big-centered">We'll see you back here in an hour.  Enjoy!</p>
</div>
</div>
</body>
</html>
