<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Python Web Programming</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Python Web Programming</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Python Web Programming</h1>

<img alt="img/bike.jpg" class="align-left" src="img/bike.jpg" style="width: 50%;" />
<p>Session 5: Frameworks and Flask</p>
<div class="intro-blurb right line-block">
<div class="line">&quot;Reinventing the wheel is great</div>
<div class="line">if your goal is to learn more about the wheel&quot;</div>
<div class="line"><br /></div>
<div class="line">-- James Tauber, PyCon 2007</div>
</div>
<p class="image-credit">image: Britanglishman <a class="reference external" href="http://www.flickr.com/photos/britanglishman/5999131365/">http://www.flickr.com/photos/britanglishman/5999131365/</a> - CC-BY</p>

</div>
<div class="slide" id="a-moment-to-reflect">
<h1>A Moment to Reflect</h1>
<p>We've been at this for a couple of days now.  We've learned a great deal:</p>
<ul class="incremental simple">
<li>Sockets, the TCP/IP Stack and Basic Mechanics</li>
<li>Web Protocols and the Importance of Clear Communication</li>
<li>APIs and Consuming Data from The Web</li>
<li>CGI and WSGI and Getting Information to Your Dynamic Applications</li>
</ul>
<p class="incremental">Everything we do from here out will be based on tools built using these
<em>foundational technologies</em>.</p>
</div>
<div class="slide" id="from-now-on">
<h1>From Now On</h1>
<p>Think of everything we do as sitting on top of WSGI</p>
<p class="incremental">This may not <em>actually</em> be true</p>
<p class="incremental">But we will always be working at that level of abstraction.</p>
</div>
<div class="slide" id="frameworks">
<h1>Frameworks</h1>
<p>From Wikipedia:</p>
<p class="center incremental">A web application framework (WAF) is a software framework that is designed to
support the development of dynamic websites, web applications and web
services. The framework aims to alleviate the overhead associated with common
activities performed in Web development. For example, many frameworks provide
libraries for database access, templating frameworks and session management,
and they often promote code reuse</p>
</div>
<div class="slide" id="what-does-that-mean">
<h1>What Does That <em>Mean</em>?</h1>
<p>You use a framework to build an application.</p>
<p class="incremental">A framework allows you to build different kinds of applications.</p>
<p class="incremental">A framework abstracts what needs to be abstracted, and allows control of the
rest.</p>
<p class="incremental">Think back over the last four sessions. What were your pain points? Which bits
do you wish you didn't have to think about?</p>
</div>
<div class="slide" id="level-of-abstraction">
<h1>Level of Abstraction</h1>
<p>This last part is important when it comes to choosing a framework</p>
<ul class="incremental simple">
<li>abstraction ‚àù 1/freedom</li>
<li>The more they choose, the less you can</li>
<li><em>Every</em> framework makes choices in what to abstract</li>
<li><em>Every</em> framework makes <em>different</em> choices</li>
</ul>
</div>
<div class="slide" id="impedance-mismatch">
<h1>Impedance Mismatch</h1>
<p class="big-centered">Don't Fight the Framework</p>
</div>
<div class="slide" id="python-web-frameworks">
<h1>Python Web Frameworks</h1>
<p>There are scores of 'em (this is a partial list).</p>
<table border="1" class="incremental invisible small center docutils">
<colgroup>
<col width="18%" />
<col width="16%" />
<col width="16%" />
<col width="20%" />
<col width="29%" />
</colgroup>
<tbody valign="top">
<tr><td>Django</td>
<td>Grok</td>
<td>Pylons</td>
<td>TurboGears</td>
<td>web2py</td>
</tr>
<tr><td>Zope</td>
<td>CubicWeb</td>
<td>Enamel</td>
<td>Gizmo(QP)</td>
<td>Glashammer</td>
</tr>
<tr><td>Karrigell</td>
<td>Nagare</td>
<td>notmm</td>
<td>Porcupine</td>
<td>QP</td>
</tr>
<tr><td>SkunkWeb</td>
<td>Spyce</td>
<td>Tipfy</td>
<td>Tornado</td>
<td>WebCore</td>
</tr>
<tr><td>web.py</td>
<td>Webware</td>
<td>Werkzeug</td>
<td>WHIFF</td>
<td>XPRESS</td>
</tr>
<tr><td>AppWsgi</td>
<td>Bobo</td>
<td>Bo7le</td>
<td>CherryPy</td>
<td>circuits.web</td>
</tr>
<tr><td>Paste</td>
<td>PyWebLib</td>
<td>WebStack</td>
<td>Albatross</td>
<td>Aquarium</td>
</tr>
<tr><td>Divmod</td>
<td>Nevow</td>
<td>Flask</td>
<td>JOTWeb2</td>
<td>Python Servlet</td>
</tr>
<tr><td>Engine</td>
<td>Pyramid</td>
<td>Quixote</td>
<td>Spiked</td>
<td>weblayer</td>
</tr>
</tbody>
</table>
</div>
<div class="slide" id="choosing-a-framework">
<h1>Choosing a Framework</h1>
<p>Many folks will tell you &quot;&lt;XYZ&gt; is the <strong>best</strong> framework&quot;.</p>
<p class="incremental">In most cases, what they really mean is &quot;I know how to use &lt;XYZ&gt;&quot;</p>
<p class="incremental">In some cases, what they really mean is &quot;&lt;XYZ&gt; fits my brain the best&quot;</p>
<p class="incremental">What they usually forget is that everyone's brain (and everyone's use-case) is
different.</p>
</div>
<div class="slide" id="cris-first-law-of-frameworks">
<h1>Cris' First Law of Frameworks</h1>
<p class="center"><strong>Pick the Right Tool for the Job</strong></p>
<p class="incremental">First Corollary</p>
<p class="incremental center">The right tool is the tool that allows you to finish the job quickly and
correctly.</p>
<p class="incremental center">But how do you know which that one is?</p>
</div>
<div class="slide" id="cris-second-law-of-frameworks">
<h1>Cris' Second Law of Frameworks</h1>
<p class="big-centered">You can't know unless you try</p>
<p class="incremental center">so let's try</p>
</div>
<div class="slide" id="from-your-homework">
<h1>From Your Homework</h1>
<p>During the week, you walked through an introduction to the <em>Flask</em> web
framework. You wrote a file that looked like this:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'Hello World!'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre>
</div>
<div class="slide" id="the-outcome">
<h1>The outcome</h1>
<p>When you ran this file, you should have seen something like this in your
browser:</p>
<img alt="img/flask_hello.png" class="align-center" src="img/flask_hello.png" style="width: 80%;" />
</div>
<div class="slide" id="what-s-happening-here">
<h1>What's Happening Here?</h1>
<p>Flask the framework provides a Python class called <cite>Flask</cite>. This class
functions as a single <em>application</em> in the WSGI sense.</p>
<p class="incremental">We know a WSGI application must be a <em>callable</em> that takes the arguments
<em>environ</em> and <em>start_response</em>.</p>
<p class="incremental">It has to call the <em>start_response</em> method, providing status and headers.</p>
<p class="incremental">And it has to return an <em>iterable</em> that represents the HTTP response body.</p>
</div>
<div class="slide" id="under-the-covers">
<h1>Under the Covers</h1>
<p>In Python, an object is a <em>callable</em> if it has a <tt class="docutils literal">__call__</tt> method.</p>
<div class="incremental container">
<p>Here's the <tt class="docutils literal">__call__</tt> method of the <tt class="docutils literal">Flask</tt> class:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shortcut for :attr:`wsgi_app`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre>
</div>
<p class="incremental">As you can see, it calls another method, called <tt class="docutils literal">wsgi_app</tt>.  Let's follow
this down...</p>
</div>
<div class="slide" id="flask-wsgi-app">
<h1>Flask.wsgi_app</h1>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The actual WSGI application.
    ...
    &quot;&quot;&quot;</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
    <span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_dispatch_request</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    <span class="c">#...</span>
</pre>
<p class="incremental"><tt class="docutils literal">response</tt> is another WSGI app.  <tt class="docutils literal">Flask</tt> is actually <em>middleware</em></p>
</div>
<div class="slide" id="abstraction-layers">
<h1>Abstraction Layers</h1>
<p>Finally, way down in a package called <em>werkzeug</em>, we find this response object
and it's <tt class="docutils literal">__call__</tt> method:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process this response as WSGI application.

    :param environ: the WSGI environment.
    :param start_response: the response callable provided by the WSGI
                           server.
    :return: an application iterator
    &quot;&quot;&quot;</span>
    <span class="n">app_iter</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wsgi_response</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app_iter</span>
</pre>
</div>
<div class="slide" id="common-threads">
<h1>Common Threads</h1>
<p>All Python web frameworks that operate under the WSGI spec will do this same
sort of thing.</p>
<p class="incremental">They have to do it.</p>
<p class="incremental">And these layers of abstraction allow you, the developer to focus only on the
thing that really matters to you.</p>
<p class="incremental">Getting input from a request, and returning a response.</p>
</div>
<div class="slide" id="a-quick-reminder">
<h1>A Quick Reminder</h1>
<p>Over the week, in addition to walking through a Flask intro you did two other
tasks:</p>
<p class="incremental">You walked through a tutorial on the Python DB API2, and learned how
to use <tt class="docutils literal">sqlite3</tt> to store and retrieve data.</p>
<p class="incremental">You also read a bit about <tt class="docutils literal">Jinja2</tt>, the templating language Flask
uses out of the box, and ran some code to explore its abilities.</p>
</div>
<div class="slide" id="moving-on">
<h1>Moving On</h1>
<p>Now it is time to put all that together.</p>
<p class="incremental">We'll spend this session building a &quot;microblog&quot; application.</p>
<p class="incremental">Let's dive right in.</p>
<p class="incremental">Start by activating your Flask virtualenv</p>
</div>
<div class="slide" id="our-database">
<h1>Our Database</h1>
<p>We need first to define what an <em>entry</em> for our microblog might look like.</p>
<p class="incremental">Let's keep it a simple as possible for now.</p>
<p class="incremental">Create a new directory <tt class="docutils literal">microblog</tt>, and open a new file in it:
<tt class="docutils literal">schema.sql</tt></p>
<pre class="code sql incremental small literal-block">
<span class="k">drop</span> <span class="k">table</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">entries</span><span class="p">;</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">entries</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">integer</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">autoincrement</span><span class="p">,</span>
    <span class="n">title</span> <span class="n">string</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="nb">text</span> <span class="n">string</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
</pre>
</div>
<div class="slide" id="app-configuration">
<h1>App Configuration</h1>
<p>For any but the most trivial applications, you'll need some configuration.</p>
<p class="incremental">Flask provides a number of ways of loading configuration.  We'll be using a
config file</p>
<p class="incremental">Create a new file <tt class="docutils literal">microblog.cfg</tt> in the same directory.</p>
<pre class="code python small incremental literal-block">
<span class="c"># application configuration for a Flask microblog</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="s">'microblog.db'</span>
</pre>
</div>
<div class="slide" id="our-app-skeleton">
<h1>Our App Skeleton</h1>
<p>Finally, we'll need a basic app skeleton to work from.</p>
<p class="incremental">Create one more file <tt class="docutils literal">microblog.py</tt> in the same directory, and enter the
following:</p>
<pre class="code python small incremental literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s">'microblog.cfg'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="test-your-work">
<h1>Test Your Work</h1>
<p>This is enough to get us off the ground.</p>
<div class="incremental container">
<p>From a terminal in the <tt class="docutils literal">microblog</tt> directory, run the app:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog.py
* Running on http://127.0.0.1:5000/
* Restarting with reloader
</pre>
</div>
<p class="incremental">Then point your browser at <a class="reference external" href="http://localhost:5000/">http://localhost:5000/</a></p>
<p class="incremental">What do you see in your browser?  In the terminal?  Why?</p>
</div>
<div class="slide" id="creating-the-database">
<h1>Creating the Database</h1>
<p>Quit the app with <tt class="docutils literal">^C</tt>. Then return to <tt class="docutils literal">microblog.py</tt> and add the
following:</p>
<pre class="code python incremental small literal-block">
<span class="c"># add this up at the top</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="c"># add the rest of this below the app.config statement</span>
<span class="k">def</span> <span class="nf">connect_db</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DATABASE'</span><span class="p">])</span>
</pre>
<p class="incremental">This should look familiar. What will happen?</p>
<p class="incremental">This convenience method allows us to write our very first test.</p>
</div>
<div class="slide" id="tests-and-tdd">
<h1>Tests and TDD</h1>
<p class="center"><strong>If it isn't tested, it's broken</strong></p>
<p class="incremental">We are going to write tests at every step of this exercise using the
<tt class="docutils literal">unittest</tt> module.</p>
<p class="incremental">In your <tt class="docutils literal">microblog</tt> folder create a <tt class="docutils literal">microblog_tests.py</tt> file.</p>
<p class="incremental">Open it in your editor.</p>
</div>
<div class="slide" id="testing-setup">
<h1>Testing Setup</h1>
<p>Add the following to provide minimal test setup.</p>
<pre class="code python small literal-block">
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">import</span> <span class="nn">microblog</span>

<span class="k">class</span> <span class="nc">MicroblogTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db_fd</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_fd</span><span class="p">,</span> <span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DATABASE'</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_fd</span>
        <span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TESTING'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">app</span>
</pre>
</div>
<div class="slide" id="testing-teardown">
<h1>Testing Teardown</h1>
<p><strong>Add</strong> this method to your existing test case class to tear down after each
test:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">MicroblogTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_fd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DATABASE'</span><span class="p">])</span>
</pre>
</div>
<div class="slide" id="make-tests-runnable">
<h1>Make Tests Runnable</h1>
<p>Finally, we make our tests runnable by adding a <tt class="docutils literal">main</tt> block:</p>
<div class="incremental container">
<p>Add the following at the end of <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre>
</div>
<p class="incremental">Now, we're ready to add our first actual test..</p>
</div>
<div class="slide" id="test-database-setup">
<h1>Test Database Setup</h1>
<p>We'd like to test that our database is correctly initialized. The schema has
one table with three columns. Let's test that.</p>
<div class="incremental container">
<p><strong>Add</strong> the following method to your test class in <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_database_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">connect_db</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'PRAGMA table_info(entries);'</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</pre>
</div>
</div>
<div class="slide" id="run-the-tests">
<h1>Run the Tests</h1>
<p>We can now run our test module:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
F
======================================================================
FAIL: test_database_setup (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 23, in test_database_setup
    self.assertEquals(len(rows) == 3)
AssertionError: 0 != 3

----------------------------------------------------------------------
Ran 1 test in 0.011s

FAILED (failures=1)
</pre>
</div>
<div class="slide" id="make-the-test-pass">
<h1>Make the Test Pass</h1>
<p>This is an expected failure. Why?</p>
<div class="incremental container">
<p>Let's add some code to <tt class="docutils literal">microblog.py</tt> that will actually create our
database schema:</p>
<pre class="code python small literal-block">
<span class="c"># add this import at the top</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>

<span class="c"># add this function after the connect_db function</span>
<span class="k">def</span> <span class="nf">init_db</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">connect_db</span><span class="p">())</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="s">'schema.sql'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre>
</div>
</div>
<div class="slide" id="initialize-the-db-in-tests">
<h1>Initialize the DB in Tests</h1>
<p>We also need to call that function in our <tt class="docutils literal">microblog_tests.py</tt> to set up the
database schema for each test.</p>
<div class="incremental container">
<p>Add the following line at the end of that <tt class="docutils literal">setUp</tt> method:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">microblog</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span> <span class="c"># &lt;- add this at the end</span>
</pre>
</div>
<pre class="incremental literal-block">
(flaskenv)$ python microblog_tests.py
</pre>
</div>
<div class="slide" id="success">
<h1>Success?</h1>
<p class="big-centered incremental">\o/ Wahoooo!</p>
</div>
<div class="slide" id="initialize-the-db-irl">
<h1>Initialize the DB IRL</h1>
<p>Our test passed, so we have confidence that <tt class="docutils literal">init_db</tt> does what it should</p>
<p class="incremental">We'll need to have a working database for our app, so let's go ahead and do
this &quot;in real life&quot;</p>
<p class="incremental">(flaskenv)$ python</p>
<pre class="code python incremental literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">microblog</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">microblog</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">^</span><span class="n">D</span>
</pre>
</div>
<div class="slide" id="first-break">
<h1>First Break</h1>
<p>After you quit the interpreter, you should see <tt class="docutils literal">microblog.db</tt> in your
directory.</p>
<p class="incremental">Let's take a few minutes here to rest and consider what we've done.</p>
<p class="incremental">When we return, we'll start writing data to our database, and reading it back
out.</p>
</div>
<div class="slide" id="reading-and-writing-data">
<h1>Reading and Writing Data</h1>
<p>Before the break, we created a function that would initialize our database.</p>
<p class="incremental">It's time now to think about writing and reading data for our blog.</p>
<p class="incremental">We'll start by writing tests.</p>
<p class="incremental">But first, a word or two about the circle of life.</p>
</div>
<div class="slide" id="the-request-response-cycle">
<h1>The Request/Response Cycle</h1>
<p>Every interaction in HTTP is bounded by the interchange of one request and one
response.</p>
<p class="incremental">No HTTP application can do anything until some client makes a request.</p>
<p class="incremental">And no action by an application is complete until a response has been sent
back to the client.</p>
<p class="incremental">This is the lifecycle of an http web application.</p>
</div>
<div class="slide" id="managing-db-connections">
<h1>Managing DB Connections</h1>
<p>It makes sense to bind the lifecycle of a database connection to this same
border.</p>
<p class="incremental">Flask does not dictate that we write an application that uses a database.</p>
<p class="incremental">Because of this, managing the lifecycle of database connection so that they
are connected to the request/response cycle is up to us.</p>
<p class="incremental">Happily, Flask <em>does</em> have a way to help us.</p>
</div>
<div class="slide" id="request-boundary-decorators">
<h1>Request Boundary Decorators</h1>
<p>The Flask <em>app</em> provides decorators we can use on our database lifecycle
functions:</p>
<ul class="incremental simple">
<li><tt class="docutils literal">&#64;app.before_request</tt>: any method decorated by this will be called before
the cycle begins</li>
<li><tt class="docutils literal">&#64;app.after_request</tt>: any method decorated by this will be called after
the cycle is complete. If an unhandled exception occurs, these functions are
skipped.</li>
<li><tt class="docutils literal">&#64;app.teardown_request</tt>: any method decorated by this will be called at
the end of the cycle, <em>even if</em> an unhandled exception occurs.</li>
</ul>
</div>
<div class="slide" id="managing-our-db">
<h1>Managing our DB</h1>
<p>Consider the following functions:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">get_database_connection</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="nd">&#64;app.teardown_request</span>
<span class="k">def</span> <span class="nf">teardown_request</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
<p class="incremental">How does the <tt class="docutils literal">db</tt> object get from one place to the other?</p>
</div>
<div class="slide" id="global-context-in-flask">
<h1>Global Context in Flask</h1>
<p>Our flask <tt class="docutils literal">app</tt> is only really instantiated once</p>
<p class="incremental">This means that anything we tie to it will be shared across all requests.</p>
<p class="incremental">This is what we call <tt class="docutils literal">global</tt> context.</p>
<p class="incremental">What happens if two clients make a request at the same time?</p>
</div>
<div class="slide" id="local-context-in-flask">
<h1>Local Context in Flask</h1>
<p>Flask provides something it calls a <tt class="docutils literal">local global</tt>: &quot;g&quot;.</p>
<p class="incremental">This is an object that <em>looks</em> global (you can import it anywhere)</p>
<p class="incremental">But in reality, it is <em>local</em> to a single request.</p>
<p class="incremental">Resources tied to this object are <em>not</em> shared among requests. Perfect for
things like a database connection.</p>
</div>
<div class="slide" id="working-db-functions">
<h1>Working DB Functions</h1>
<p>Add the following, working methods to <tt class="docutils literal">microblog.py</tt>:</p>
<pre class="code python small literal-block">
<span class="c"># add this import at the top:</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">g</span>

<span class="c"># add these function after init_db</span>
<span class="k">def</span> <span class="nf">get_database_connection</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">'db'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="nd">&#64;app.teardown_request</span>
<span class="k">def</span> <span class="nf">teardown_request</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">'db'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
</div>
<div class="slide" id="writing-blog-entries">
<h1>Writing Blog Entries</h1>
<p>Our microblog will have <em>entries</em>. We've set up a simple database schema to
represent them.</p>
<p class="incremental">To write an entry, what would we need to do?</p>
<ul class="incremental simple">
<li>Provide a title</li>
<li>Provide some body text</li>
<li>Write them to a row in the database</li>
</ul>
<p class="incremental">Let's write a test of a function that would do that.</p>
</div>
<div class="slide" id="test-writing-entries">
<h1>Test Writing Entries</h1>
<p>The database connection is bound by a request. We'll need to mock one (in
<tt class="docutils literal">microblog_tests.py</tt>)</p>
<div class="incremental container">
<p>Flask provides <tt class="docutils literal">app.test_request_context</tt> to do just that</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_write_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;My Title&quot;</span><span class="p">,</span> <span class="s">&quot;My Text&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="n">microblog</span><span class="o">.</span><span class="n">write_entry</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">connect_db</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select * from entries;&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">val</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre>
</div>
</div>
<div class="slide" id="run-your-test">
<h1>Run Your Test</h1>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
.E
======================================================================
ERROR: test_write_entry (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 30, in test_write_entry
    microblog.write_entry(*expected)
AttributeError: 'module' object has no attribute 'write_entry'

----------------------------------------------------------------------
Ran 2 tests in 0.018s

FAILED (errors=1)
</pre>
<p class="incremental">Great.  Two tests, one passing.</p>
</div>
<div class="slide" id="make-it-pass">
<h1>Make It Pass</h1>
<p>Now we are ready to write an entry to our database. Add this function to
<tt class="docutils literal">microblog.py</tt>:</p>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">write_entry</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">get_database_connection</span><span class="p">()</span>
    <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into entries (title, text) values (?, ?)'</span><span class="p">,</span>
                 <span class="p">[</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">])</span>
    <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre>
<pre class="incremental small literal-block">
(flaskenv)$ python microblog_tests.py
..
----------------------------------------------------------------------
Ran 2 tests in 0.146s

OK
</pre>
</div>
<div class="slide" id="reading-entries">
<h1>Reading Entries</h1>
<p>We'd also like to be able to read the entries in our blog</p>
<div class="incremental container">
<p>We need a method that returns all of them for a listing page</p>
<ul class="incremental simple">
<li>The return value should be a list of entries</li>
<li>If there are none, it should return an empty list</li>
<li>Each entry in the list should be a dictionary of 'title' and 'text'</li>
</ul>
</div>
<p class="incremental">Let's begin by writing tests.</p>
</div>
<div class="slide" id="test-reading-entries">
<h1>Test Reading Entries</h1>
<p>In <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_get_all_entries_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">get_all_entries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_get_all_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;My Title&quot;</span><span class="p">,</span> <span class="s">&quot;My Text&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="n">microblog</span><span class="o">.</span><span class="n">write_entry</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">get_all_entries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s">'title'</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s">'text'</span><span class="p">])</span>
</pre>
</div>
<div class="slide" id="run-your-tests">
<h1>Run Your Tests</h1>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
.EE.
======================================================================
ERROR: test_get_all_entries (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 47, in test_get_all_entries
    entries = microblog.get_all_entries()
AttributeError: 'module' object has no attribute 'get_all_entries'

======================================================================
ERROR: test_get_all_entries_empty (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 40, in test_get_all_entries_empty
    entries = microblog.get_all_entries()
AttributeError: 'module' object has no attribute 'get_all_entries'

----------------------------------------------------------------------
Ran 4 tests in 0.021s

FAILED (errors=2)
</pre>
</div>
<div class="slide" id="make-them-pass">
<h1>Make Them Pass</h1>
<p>Now we have 4 tests, and two fail.</p>
<p class="incremental">add the <tt class="docutils literal">get_all_entries</tt> function to <tt class="docutils literal">microblog.py</tt>:</p>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">get_all_entries</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">get_database_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT title, text FROM entries ORDER BY id DESC'</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</pre>
<div class="incremental container">
<p>And back in your terminal:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
....
----------------------------------------------------------------------
Ran 4 tests in 0.021s

OK
</pre>
</div>
</div>
<div class="slide" id="where-we-stand">
<h1>Where We Stand</h1>
<p>We've moved quite a ways in implementing our microblog:</p>
<ul class="incremental simple">
<li>We've created code to initialize our database schema</li>
<li>We've added functions to manage the lifecycle of our database connection</li>
<li>We've put in place functions to write and read blog entries</li>
<li>And, since it's tested, we are reasonably sure our code does what we think
it does.</li>
</ul>
<p class="incremental">We're ready now to put a face on it, so we can see what we're doing!</p>
</div>
<div class="slide" id="second-break">
<h1>Second Break</h1>
<p>But first, let's take a quick break to clear our heads.</p>
</div>
<div class="slide" id="templates-in-flask">
<h1>Templates In Flask</h1>
<p>We'll start with a detour into templates as they work in Flask</p>
<div class="incremental container">
<p>Jinja2 templates use the concept of an <em>Environment</em> to:</p>
<ul class="incremental simple">
<li>Figure out where to look for templates</li>
<li>Set configuration for the templating system</li>
<li>Add some commonly used functionality to the template <em>context</em></li>
</ul>
</div>
<p class="incremental">Flask sets up a proper Jinja2 Environment when you instantiate your <tt class="docutils literal">app</tt>.</p>
</div>
<div class="slide" id="flask-environment">
<h1>Flask Environment</h1>
<p>Flask uses the value you pass to the <tt class="docutils literal">app</tt> constructor to calculate the root
of your application on the filesystem.</p>
<p class="incremental">From that root, it expects to find templates in a directory name <tt class="docutils literal">templates</tt></p>
<div class="incremental container">
<p>This allows you to use the <tt class="docutils literal">render_template</tt> command from <tt class="docutils literal">flask</tt> like
so:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="n">page_html</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'hello_world.html'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Cris&quot;</span><span class="p">)</span>
</pre>
</div>
</div>
<div class="slide" id="flask-context">
<h1>Flask Context</h1>
<p>Keyword arguments you pass to <tt class="docutils literal">render_template</tt> become the <em>context</em> passed
to the template for rendering.</p>
<p class="incremental">Flask will add a few things to this context.</p>
<ul class="incremental simple">
<li><strong>config</strong>: contains the current configuration object</li>
<li><strong>request</strong>: contains the current request object</li>
<li><strong>session</strong>: any session data that might be available</li>
<li><strong>g</strong>: the request-local object to which global variables are bound</li>
<li><strong>url_for</strong>: so you can easily <em>reverse</em> urls from within your templates</li>
<li><strong>get_flashed_messages</strong>: a function that returns messages you flash to your
users (more on this later).</li>
</ul>
</div>
<div class="slide" id="setting-up-our-templates">
<h1>Setting Up Our Templates</h1>
<p>In your <tt class="docutils literal">microblog</tt> directory, add a new <tt class="docutils literal">templates</tt> directory</p>
<div class="incremental container">
<p>In this directory create a new file <tt class="docutils literal">layout.html</tt></p>
<pre class="code jinja small literal-block">
<span class="x">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Microblog!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;My Microblog&lt;/h1&gt;
    &lt;div class=&quot;content&quot;&gt;
    </span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x">
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</span>
</pre>
</div>
</div>
<div class="slide" id="template-inheritance">
<h1>Template Inheritance</h1>
<p>You can combine templates in a number of different ways.</p>
<ul class="incremental simple">
<li>you can make replaceable blocks in templates with blocks<ul>
<li><tt class="docutils literal">{% block foo <span class="pre">%}{%</span> endblock %}</tt></li>
</ul>
</li>
<li>you can build on a template in a second template by extending<ul>
<li><tt class="docutils literal">{% extends &quot;layout.html&quot; %}</tt></li>
<li>this <em>must</em> be the first text in the template</li>
</ul>
</li>
<li>you can re-use common structure with <em>include</em>:<ul>
<li><tt class="docutils literal">{% include &quot;footer.html&quot; %}</tt></li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="displaying-an-entries-list">
<h1>Displaying an Entries List</h1>
<p>Create a new file, <tt class="docutils literal">show_entries.html</tt> in <tt class="docutils literal">templates</tt>:</p>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;layout.html&quot;</span> <span class="cp">%}</span><span class="x">
</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x">
  &lt;h2&gt;Posts&lt;/h2&gt;
  &lt;ul class=&quot;entries&quot;&gt;
  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">entry</span> <span class="k">in</span> <span class="nv">entries</span> <span class="cp">%}</span><span class="x">
    &lt;li&gt;
      &lt;h2&gt;</span><span class="cp">{{</span> <span class="nv">entry.title</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;
      &lt;div class=&quot;entry_body&quot;&gt;
      </span><span class="cp">{{</span> <span class="nv">entry.text</span><span class="o">|</span><span class="nf">safe</span> <span class="cp">}}</span><span class="x">
      &lt;/div&gt;
    &lt;/li&gt;
  </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x">
    &lt;li&gt;&lt;em&gt;No entries here so far&lt;/em&gt;&lt;/li&gt;
  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
  &lt;/ul&gt;
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="viewing-entries">
<h1>Viewing Entries</h1>
<p>We just need a Python function that will:</p>
<ul class="incremental simple">
<li>build a list of entries</li>
<li>pass the list to our template to be rendered</li>
<li>return the result to a client's browser</li>
</ul>
<p class="incremental">As usual, we'll start by writing tests for this new function</p>
</div>
<div class="slide" id="test-viewing-entries">
<h1>Test Viewing Entries</h1>
<p>Add the following two tests to <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_empty_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s">'No entries here so far'</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">expected</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;My Title&quot;</span><span class="p">,</span> <span class="s">&quot;My Text&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="n">microblog</span><span class="o">.</span><span class="n">write_entry</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">)</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">)</span>
</pre>
<p class="incremental"><tt class="docutils literal">app.test_client()</tt> creates a mock http client for us.</p>
</div>
<div class="slide" id="id1">
<h1>Run Your Tests</h1>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
.F..F.
======================================================================
FAIL: test_empty_listing (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 55, in test_empty_listing
    assert 'No entries here so far' in response.data
AssertionError
======================================================================
FAIL: test_listing (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 63, in test_listing
    assert value in response.data
AssertionError
----------------------------------------------------------------------
Ran 6 tests in 0.138s

FAILED (failures=2)
</pre>
</div>
<div class="slide" id="id2">
<h1>Make Them Pass</h1>
<p>In <tt class="docutils literal">microblog.py</tt>:</p>
<pre class="code python small literal-block">
<span class="c"># at the top, import</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="c"># and after our last functions:</span>
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_entries</span><span class="p">():</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">get_all_entries</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'show_entries.html'</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="n">entries</span><span class="p">)</span>
</pre>
<pre class="incremental small literal-block">
(flaskenv)$ python microblog_tests.py
......
----------------------------------------------------------------------
Ran 6 tests in 0.100s

OK
</pre>
</div>
<div class="slide" id="creating-entries">
<h1>Creating Entries</h1>
<p>We still lack a way to add an entry. We need a view that will:</p>
<ul class="incremental simple">
<li>Accept incoming form data from a request</li>
<li>Get the data for <tt class="docutils literal">title</tt> and <tt class="docutils literal">text</tt></li>
<li>Create a new entry in the database</li>
<li>Throw an appropriate HTTP error if that fails</li>
<li>Show the user the list of entries when done.</li>
</ul>
<p class="incremental">Again, first come the tests.</p>
</div>
<div class="slide" id="testing-add-an-entry">
<h1>Testing Add an Entry</h1>
<p>Add this to <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_add_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'/add'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s">'Hello'</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="s">'This is a post'</span>
    <span class="p">),</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="s">'No entries here so far'</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'Hello'</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">'This is a post'</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id3">
<h1>Run Your Tests</h1>
<p>Verify that our test fails as expected:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
F......
======================================================================
FAIL: test_add_entries (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 72, in test_add_entries
    self.assertTrue('Hello' in actual)
AssertionError: False is not true

----------------------------------------------------------------------
Ran 7 tests in 0.050s

FAILED (failures=1)
</pre>
</div>
<div class="slide" id="id4">
<h1>Make Them Pass</h1>
<p>We have all we need to write entries, all we lack is an endpoint (in
<tt class="docutils literal">microblog.py</tt>):</p>
<pre class="code python small literal-block">
<span class="c"># add imports</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/add'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_entry</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">write_entry</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'text'</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'show_entries'</span><span class="p">))</span>
</pre>
</div>
<div class="slide" id="and">
<h1>And...?</h1>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
.......
----------------------------------------------------------------------
Ran 7 tests in 0.047s

OK
</pre>
<p class="incremental center"><strong>Hooray!</strong></p>
</div>
<div class="slide" id="where-do-entries-come-from">
<h1>Where do Entries Come From</h1>
<p>Finally, we're almost done. We can add entries and view them. But look at that
last view. Do you see a call to <tt class="docutils literal">render_template</tt> in there at all?</p>
<p class="incremental">There isn't one. That's because that view is never meant to be be visible.
Look carefully at the logic. What happens?</p>
<p class="incremental">So where do the form values come from?</p>
<p class="incremental">Let's add a form to the main view.  Open <tt class="docutils literal">show_entries.html</tt></p>
</div>
<div class="slide" id="provide-a-form">
<h1>Provide a Form</h1>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x">  &lt;!-- already there --&gt;
&lt;form action=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'add_entry'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot; method=&quot;POST&quot; class=&quot;add_entry&quot;&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label for=&quot;title&quot;&gt;Title&lt;/label&gt;
    &lt;input type=&quot;text&quot; size=&quot;30&quot; name=&quot;title&quot; id=&quot;title&quot;/&gt;
  &lt;/div&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label for=&quot;text&quot;&gt;Text&lt;/label&gt;
    &lt;textarea name=&quot;text&quot; id=&quot;text&quot; rows=&quot;5&quot; cols=&quot;80&quot;&gt;&lt;/textarea&gt;
  &lt;/div&gt;
  &lt;div class=&quot;control_row&quot;&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Share&quot; name=&quot;Share&quot;/&gt;
  &lt;/div&gt;
&lt;/form&gt;
&lt;h2&gt;Posts&lt;/h2&gt;  &lt;!-- already there --&gt;</span>
</pre>
</div>
<div class="slide" id="all-done">
<h1>All Done</h1>
<p>Okay.  That's it.  We've got an app all written.</p>
<p class="incremental">So far, we haven't actually touched our browsers at all, but we have
reasonable certainty that this works because of our tests. Let's try it.</p>
<p class="incremental">In the terminal where you've been running tests, run our microblog app:</p>
<pre class="incremental literal-block">
(flaskenv)$ python microblog.py
* Running on http://127.0.0.1:5000/
* Restarting with reloader
</pre>
</div>
<div class="slide" id="the-big-payoff">
<h1>The Big Payoff</h1>
<p>Now load <tt class="docutils literal"><span class="pre">http://localhost:5000/</span></tt> in your browser and enjoy your reward.</p>
</div>
<div class="slide" id="making-it-pretty">
<h1>Making It Pretty</h1>
<p>What we've got here is pretty ugly.</p>
<p class="incremental">If you've fallen behind, or want to start fresh, you can find the finished
<tt class="docutils literal">microblog</tt> directory in the class resources.</p>
<p class="incremental">In that directory inside the <tt class="docutils literal">static</tt> directory you will find
<tt class="docutils literal">styles.css</tt>. Open it in your editor.  It contains basic CSS for this app.</p>
<p class="incremental">We'll need to include this file in our <tt class="docutils literal">layout.html</tt>.</p>
</div>
<div class="slide" id="static-files">
<h1>Static Files</h1>
<p>Like page templates, Flask locates static resources like images, css and
javascript by looking for a <tt class="docutils literal">static</tt> directory relative to the app root.</p>
<p class="incremental">You can use the special url endpoint <tt class="docutils literal">static</tt> to build urls that point here.
Open <tt class="docutils literal">layout.html</tt> and add the following:</p>
<pre class="code jinja small incremental literal-block">
<span class="x">&lt;head&gt;  &lt;!-- you only need to add the &lt;link&gt; below --&gt;
  &lt;title&gt;Flaskr&lt;/title&gt;
  &lt;link href=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'static'</span><span class="o">,</span> <span class="nv">filename</span><span class="o">=</span><span class="s1">'style.css'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;
&lt;/head&gt;</span>
</pre>
</div>
<div class="slide" id="reap-the-rewards">
<h1>Reap the Rewards</h1>
<p>Make sure that your <cite>microblog</cite> folder has a <cite>static</cite> folder inside it, and
that the <cite>styles.css</cite> file is in it.</p>
<p class="incremental">Then, reload your web browser and see the difference a bit of style can make.</p>
</div>
<div class="slide" id="homework">
<h1>Homework</h1>
<p>We've built a simple microblog application in the <em>Flask</em> web framework.</p>
<p class="incremental">For your homework this week I'd like you to add two features to this app.</p>
<ol class="incremental arabic simple">
<li>Authentication</li>
<li>Flash messaging</li>
</ol>
</div>
<div class="slide" id="authentication-specifications">
<h1>Authentication Specifications</h1>
<p>Writing new entries should be restricted to users who have logged in. This
means that:</p>
<ul class="incremental simple">
<li>The form to create a new entry should only be visible to logged in users</li>
<li>There should be a visible link to allow a user to log in</li>
<li>This link should display a login form that expects a username and password</li>
<li>If the user provides incorrect login information, this form should tell her
so.</li>
<li>If the user provides correct login information, she should end up at the
list page</li>
<li>Once logged in, the user should see a link to log out.</li>
<li>Upon clicking that link, the system should no longer show the entry form and
the log in link should re-appear.</li>
</ul>
</div>
<div class="slide" id="flash-messaging-specifications">
<h1>Flash Messaging Specifications</h1>
<p>A flask app provides a method called <cite>flash</cite> that allows passing messages from
a view function into a template context so that they can be viewed by a user.</p>
<p class="incremental">Use this method to provide the following messages to users:</p>
<ul class="incremental simple">
<li>Upon a successful login, display the message &quot;You are logged in&quot;</li>
<li>Upon a successful logout, display the message &quot;You have logged out&quot;</li>
<li>Upon posting a successful new entry, display the message &quot;New entry posted&quot;</li>
<li>If adding an entry causes an error, instead of returning a 500 response,
alert the user to the error by displaying the error message to the user.</li>
</ul>
</div>
<div class="slide" id="resources-to-use">
<h1>Resources to Use</h1>
<p>The microblog we created today comes from the tutorial on the <cite>flask</cite> website.
I've modified that tutorial to omit authentication and flash messaging. You can
refer to the tutorial and to the flask api documentation to learn what you need
to accomplish these tasks.</p>
<p><a class="reference external" href="http://flask.pocoo.org/docs/tutorial/">The Flask Tutorial</a></p>
<p><a class="reference external" href="http://flask.pocoo.org/docs/api/">Flask API Documentation</a></p>
<p>Both features depend on <em>sessions</em>, so you will want to pay particular
attention to how a session is enabled and what you can do with it once it
exists.</p>
</div>
<div class="slide" id="next-week">
<h1>Next Week</h1>
<p>Next week we are going to mix things up a little and do something quite
different.</p>
<p class="incremental">We'll be starting from the app you have just built (with the additional
features you complete over the week).</p>
<p class="incremental">We will divide into pairs and each pair will select one feature from a list I
will provide.</p>
<p class="incremental">We'll spend the entire class implementing this feature, and at 8:15, each pair
will show their work to the class.</p>
</div>
<div class="slide" id="wrap-up">
<h1>Wrap-Up</h1>
<p>For educational purposes you might try taking a look at the source code for
Flask and Werkzeug.  Neither is too large a package.</p>
<p class="incremental">In particular seeing how Werkzeug sets up a Request and Response--and how
these relate to the WSGI specification--can be very enlightening.</p>
</div>
</div>
</body>
</html>
